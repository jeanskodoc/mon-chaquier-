<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ESODI Facturation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* RESET MOBILE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }
        
        html {
            font-size: 16px;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.5;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        /* CONTAINER MOBILE */
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            position: relative;
        }
        
        /* HEADER MOBILE */
        header {
            background: linear-gradient(135deg, #006400 0%, #228B22 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: relative;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .logo-icon {
            font-size: 28px;
            background: white;
            color: #006400;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
            flex-shrink: 0;
        }
        
        header h1 {
            font-size: 20px;
            margin-bottom: 5px;
            line-height: 1.3;
        }
        
        header p {
            opacity: 0.9;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .whatsapp-auto-notice {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        /* TABS MOBILE */
        .tabs {
            display: flex;
            background-color: #f0f4f8;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 16px 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tab.active {
            background-color: white;
            color: #006400;
            border-bottom: 3px solid #006400;
        }
        
        /* TAB CONTENT MOBILE */
        .tab-content {
            display: none;
            padding: 20px 15px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* FORM SECTIONS MOBILE */
        .form-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 17px;
            color: #006400;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            width: 100%;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px 12px;
            border: 1.5px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s;
            background: #fafafa;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #006400;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
            background: white;
        }
        
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23006400' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* BOUTONS MOBILE */
        .btn {
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-color: #006400;
            color: white;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        /* PREVIEW FACTURE MOBILE */
        .invoice-preview {
            background-color: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border: 1.5px solid #e5e7eb;
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .invoice-header {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #006400;
        }
        
        .company-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .logo-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(135deg, #006400 0%, #228B22 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .invoice-details {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .invoice-items-mobile {
            margin-bottom: 20px;
        }
        
        .invoice-item-mobile {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #eee;
        }
        
        .invoice-totals {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }
        
        .total-row:last-child {
            font-size: 17px;
            font-weight: 700;
            color: #006400;
            border-bottom: none;
        }
        
        .amount-in-words {
            background-color: #f0fff0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #006400;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .currency-badge {
            background-color: #006400;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
            display: inline-block;
        }
        
        /* SIGNATURE MOBILE */
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }
        
        .signature-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 15px;
        }
        
        .signature-box {
            width: 100%;
        }
        
        .signature-pad-container {
            width: 100%;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            margin-top: 8px;
            background-color: white;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }
        
        .signature-pad {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            cursor: crosshair;
        }
        
        .signature-instructions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            text-align: center;
            padding: 20px;
            z-index: 1;
            pointer-events: none;
        }
        
        .signature-instructions i {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .signature-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-clear {
            background-color: #ef4444;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        
        .signature-save {
            background-color: #006400;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        
        /* STATUS MESSAGES MOBILE */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        /* WHATSAPP AUTO OPTION MOBILE */
        .whatsapp-auto-option {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #c8e6c9;
        }
        
        .auto-whatsapp-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 10px 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #25D366;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* FOOTER MOBILE */
        footer {
            text-align: center;
            padding: 20px 15px;
            margin-top: 25px;
            color: #666;
            font-size: 12px;
            line-height: 1.5;
            border-top: 1px solid #eee;
        }
        
        /* MEDIA QUERIES */
        @media (min-width: 480px) {
            body {
                padding: 15px;
            }
            
            header h1 {
                font-size: 22px;
            }
            
            .tab {
                font-size: 16px;
                padding: 16px 12px;
            }
            
            .btn {
                padding: 16px 24px;
            }
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                max-width: 95%;
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1;
                min-width: calc(50% - 10px);
            }
            
            .signature-container {
                flex-direction: row;
            }
            
            .signature-box {
                flex: 1;
            }
            
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .btn {
                width: auto;
                flex: 1;
                min-width: calc(50% - 10px);
            }
            
            .invoice-header {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .invoice-details {
                flex-direction: row;
            }
        }
        
        /* CARD STYLE FOR ITEMS */
        .item-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .item-card-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            flex: 1;
        }
        
        .item-card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .item-card-detail {
            display: flex;
            flex-direction: column;
        }
        
        .item-card-label {
            font-weight: 500;
            color: #888;
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        /* SIGNATURE PREVIEW */
        .signature-preview-img {
            max-width: 200px;
            max-height: 80px;
            border: 1px solid #ccc;
            padding: 5px;
            background: white;
            border-radius: 5px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo-icon">
                    ES
                </div>
                <div style="flex: 1; min-width: 0;">
                    <h1>ESODI Facturation</h1>
                    <p>Créez et envoyez des factures en FCFA par WhatsApp</p>
                    <div class="whatsapp-auto-notice">
                        <i class="fab fa-whatsapp"></i> Envoi WhatsApp automatique
                    </div>
                </div>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="owner">ESODI</div>
            <div class="tab" data-tab="client">Facture</div>
        </div>
        
        <div id="owner-tab" class="tab-content active">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-building"></i> Entreprise ESODI</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="owner-name">Nom entreprise</label>
                        <input type="text" id="owner-name" value="ESODI" readonly>
                    </div>
                    <div class="form-group">
                        <label for="owner-phone">Téléphone WhatsApp</label>
                        <input type="tel" id="owner-phone" value="+22892871605" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="owner-email">Email</label>
                        <input type="email" id="owner-email" value="jeanskodoc22@gmail.com" readonly>
                    </div>
                    <div class="form-group">
                        <label for="owner-address">Adresse</label>
                        <input type="text" id="owner-address" placeholder="Saisir l'adresse ESODI">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="owner-siret">N° RCCM</label>
                        <input type="text" id="owner-siret" placeholder="Numéro RCCM">
                    </div>
                </div>
                
                <div class="whatsapp-auto-option">
                    <h3 style="font-size: 16px; margin-bottom: 10px; color: #006400;">
                        <i class="fab fa-whatsapp"></i> WhatsApp Automatique
                    </h3>
                    
                    <div class="auto-whatsapp-toggle">
                        <span style="font-weight: 600; font-size: 15px;">Envoi automatique</span>
                        <div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-whatsapp" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <p style="margin-top: 10px; font-size: 13px; color: #555; line-height: 1.4;">
                        <i class="fas fa-info-circle"></i> La facture sera automatiquement envoyée au client par WhatsApp lors de l'enregistrement.
                    </p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="save-owner">
                    <i class="fas fa-save"></i> Sauvegarder
                </button>
                <button class="btn btn-success go-to-client">
                    <i class="fas fa-file-invoice"></i> Nouvelle Facture
                </button>
            </div>
            
            <div id="owner-status" class="status-message"></div>
        </div>
        
        <div id="client-tab" class="tab-content">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-user"></i> Client</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-name">Nom du client *</label>
                        <input type="text" id="client-name" placeholder="Nom complet ou entreprise">
                    </div>
                    <div class="form-group">
                        <label for="client-phone">Téléphone WhatsApp *</label>
                        <input type="tel" id="client-phone" placeholder="Ex: +228 90 12 34 56">
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
                            La facture sera envoyée à ce numéro
                        </small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-email">Email (optionnel)</label>
                        <input type="email" id="client-email" placeholder="client@email.com">
                    </div>
                    <div class="form-group">
                        <label for="client-address">Adresse (optionnel)</label>
                        <input type="text" id="client-address" placeholder="Adresse du client">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-receipt"></i> Détails Facture</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoice-number">N° Facture *</label>
                        <input type="text" id="invoice-number" value="FACT-ESODI-2023-001">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoice-date">Date facturation *</label>
                        <input type="date" id="invoice-date">
                    </div>
                    <div class="form-group">
                        <label for="due-date">Date échéance *</label>
                        <input type="date" id="due-date">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-method">Méthode paiement</label>
                        <select id="payment-method">
                            <option value="Mobile Money" selected>Mobile Money</option>
                            <option value="Virement bancaire">Virement bancaire</option>
                            <option value="Espèces">Espèces</option>
                            <option value="Chèque">Chèque</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="invoice-notes">Notes (optionnel)</label>
                        <textarea id="invoice-notes" rows="2" placeholder="Notes additionnelles..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-boxes"></i> Articles <span class="currency-badge">FCFA</span></h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="item-description">Description *</label>
                        <input type="text" id="item-description" placeholder="Nom de l'article ou service">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="item-quantity">Quantité *</label>
                        <input type="number" id="item-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="item-price">Prix unitaire <span class="currency-badge">FCFA</span></label>
                        <input type="number" id="item-price" min="0" step="100" value="5000">
                    </div>
                    <div class="form-group">
                        <label for="item-tax">TVA (%)</label>
                        <select id="item-tax">
                            <option value="0">0%</option>
                            <option value="10" selected>10%</option>
                            <option value="18">18%</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="add-item" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> Ajouter l'article
                </button>
                
                <div id="items-list-mobile" style="margin-top: 20px;">
                    <!-- Articles sous forme de cartes pour mobile -->
                </div>
            </div>
            
            <div class="signature-section">
                <h2 class="section-title"><i class="fas fa-signature"></i> Signatures Tactiles</h2>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    <i class="fas fa-fingerprint"></i> Utilisez votre doigt pour signer directement sur l'écran.
                </p>
                
                <div class="signature-container">
                    <div class="signature-box">
                        <label style="font-size: 15px;">
                            <i class="fas fa-user"></i> Signature du client
                        </label>
                        <div class="signature-pad-container" id="client-signature-container">
                            <div class="signature-instructions">
                                <i class="fas fa-hand-pointer"></i>
                                <span>Touchez et tracez votre signature</span>
                            </div>
                            <canvas class="signature-pad" id="client-signature-canvas"></canvas>
                        </div>
                        <div class="signature-actions">
                            <button class="signature-clear" data-pad="client">
                                <i class="fas fa-eraser"></i> Effacer
                            </button>
                            <button class="signature-save" data-pad="client">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                    </div>
                    
                    <div class="signature-box">
                        <label style="font-size: 15px;">
                            <i class="fas fa-building"></i> Signature ESODI
                        </label>
                        <div class="signature-pad-container" id="owner-signature-container">
                            <div class="signature-instructions">
                                <i class="fas fa-hand-pointer"></i>
                                <span>Touchez et tracez votre signature</span>
                            </div>
                            <canvas class="signature-pad" id="owner-signature-canvas"></canvas>
                        </div>
                        <div class="signature-actions">
                            <button class="signature-clear" data-pad="owner">
                                <i class="fas fa-eraser"></i> Effacer
                            </button>
                            <button class="signature-save" data-pad="owner">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="invoice-preview">
                <h2 class="section-title"><i class="fas fa-eye"></i> Aperçu Facture</h2>
                <div id="invoice-preview-content">
                    <!-- Aperçu sera généré ici -->
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="generate-invoice">
                    <i class="fas fa-sync-alt"></i> Actualiser Aperçu
                </button>
                <button class="btn btn-success" id="save-invoice">
                    <i class="fas fa-paper-plane"></i> Envoyer Facture
                </button>
                <button class="btn btn-secondary" id="clear-form">
                    <i class="fas fa-redo"></i> Nouvelle
                </button>
            </div>
            
            <div id="invoice-status" class="status-message"></div>
        </div>
        
        <footer>
            <p style="font-weight: 600; margin-bottom: 5px;">ESODI - Facturation Digital</p>
            <p style="font-size: 11px;">WhatsApp: +228 92 87 16 05 | FCFA | Togo</p>
        </footer>
    </div>

    <script>
        // Variables globales
        let invoiceItems = [];
        let ownerInfo = {
            name: "ESODI",
            phone: "+22892871605",
            email: "jeanskodoc22@gmail.com",
            address: "",
            siret: "",
            logo: "ESODI"
        };
        
        // Variables pour les signatures
        let clientSignatureCanvas = null;
        let ownerSignatureCanvas = null;
        let clientSignatureCtx = null;
        let ownerSignatureCtx = null;
        let isDrawing = false;
        let currentSignaturePad = null;
        let lastX = 0;
        let lastY = 0;
        
        // Configuration WhatsApp automatique
        let autoWhatsAppEnabled = true;
        
        // Tables de conversion pour les nombres en lettres (version corrigée)
        const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
        const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
        const tens = ['', 'dix', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante', 'quatre-vingt', 'quatre-vingt'];
        const specialTens = ['', 'dix', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];
        
        // Formatage des nombres avec séparateurs de milliers pour FCFA
        function formatFCFA(number) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(number) + ' FCFA';
        }
        
        // Fonction complète de conversion nombre en lettres (FCFA) - CORRIGÉE
        function numberToFrenchWords(num) {
            if (num === 0) return 'Zéro francs CFA';
            
            let result = '';
            let remaining = Math.floor(num);
            
            // Gestion des milliards
            if (remaining >= 1000000000) {
                const billions = Math.floor(remaining / 1000000000);
                result += convertNumber(billions) + (billions > 1 ? ' milliards ' : ' milliard ');
                remaining %= 1000000000;
            }
            
            // Gestion des millions
            if (remaining >= 1000000) {
                const millions = Math.floor(remaining / 1000000);
                result += convertNumber(millions) + (millions > 1 ? ' millions ' : ' million ');
                remaining %= 1000000;
            }
            
            // Gestion des milliers
            if (remaining >= 1000) {
                if (remaining < 2000) {
                    result += 'mille ';
                } else {
                    const thousands = Math.floor(remaining / 1000);
                    result += convertNumber(thousands) + ' mille ';
                }
                remaining %= 1000;
            }
            
            // Gestion des unités restantes
            if (remaining > 0) {
                result += convertNumber(remaining);
            }
            
            // Nettoyer et formater
            result = result.trim();
            
            // Gérer le pluriel
            if (result.endsWith('un') && result !== 'un') {
                result = result.replace(/un$/, 'un franc CFA');
            } else {
                result += ' francs CFA';
            }
            
            // Capitaliser la première lettre
            return result.charAt(0).toUpperCase() + result.slice(1);
        }
        
        // Conversion principale des nombres
        function convertNumber(num) {
            if (num === 0) return '';
            
            let result = '';
            
            // Centaines
            if (num >= 100) {
                const hundreds = Math.floor(num / 100);
                if (hundreds === 1) {
                    result += 'cent';
                } else {
                    result += units[hundreds] + ' cent';
                }
                num %= 100;
                
                if (num > 0) {
                    result += ' ';
                } else if (hundreds > 1) {
                    result += 's';
                }
            }
            
            // Dizaines et unités
            if (num > 0) {
                if (num < 10) {
                    result += units[num];
                } else if (num < 20) {
                    result += teens[num - 10];
                } else {
                    const tensDigit = Math.floor(num / 10);
                    const unitsDigit = num % 10;
                    
                    // Cas spéciaux français
                    if (tensDigit === 7 || tensDigit === 9) {
                        const base = tensDigit === 7 ? 60 : 80;
                        const remainder = num - base;
                        
                        if (tensDigit === 7) {
                            result += 'soixante';
                        } else {
                            result += 'quatre-vingt';
                        }
                        
                        if (remainder === 0) {
                            if (tensDigit === 8) result += 's';
                        } else if (remainder === 1) {
                            result += '-et-un';
                        } else if (remainder < 10) {
                            result += '-' + units[remainder];
                        } else {
                            result += '-' + teens[remainder - 10];
                        }
                    } else {
                        // Dizaines normales
                        result += tens[tensDigit];
                        
                        if (unitsDigit === 1 && tensDigit !== 8) {
                            result += '-et-un';
                        } else if (unitsDigit > 1) {
                            result += '-' + units[unitsDigit];
                        } else if (unitsDigit === 0 && tensDigit === 8) {
                            result += 's';
                        }
                    }
                }
            }
            
            return result.trim();
        }
        
        // Version alternative plus simple pour vérification
        function numberToFrenchWordsSimple(num) {
            const units = ['zéro', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];
            
            if (num === 0) return 'Zéro francs CFA';
            
            const total = Math.floor(num);
            let result = '';
            
            // Fonction récursive pour convertir
            function convert(n) {
                if (n < 10) return units[n];
                if (n < 20) return teens[n - 10];
                
                if (n < 100) {
                    const ten = Math.floor(n / 10);
                    const unit = n % 10;
                    
                    if (ten === 7) {
                        return 'soixante' + (unit > 0 ? '-' + (unit === 1 ? 'et-' : '') + (unit < 7 ? units[unit] : teens[unit - 10]) : '');
                    }
                    if (ten === 9) {
                        return 'quatre-vingt' + (unit > 0 ? '-' + (unit === 1 ? 'et-' : '') + (unit < 7 ? units[unit] : teens[unit - 10]) : '-dix');
                    }
                    
                    if (ten === 8) {
                        return 'quatre-vingt' + (unit > 0 ? '-' + units[unit] : 's');
                    }
                    
                    return tens[ten] + (unit > 0 ? (unit === 1 ? '-et-' : '-') + units[unit] : '');
                }
                
                if (n < 1000) {
                    const hundred = Math.floor(n / 100);
                    const rest = n % 100;
                    return (hundred === 1 ? 'cent' : units[hundred] + ' cent') + (rest > 0 ? ' ' + convert(rest) : 's');
                }
                
                if (n < 1000000) {
                    const thousand = Math.floor(n / 1000);
                    const rest = n % 1000;
                    return (thousand === 1 ? 'mille' : convert(thousand) + ' mille') + (rest > 0 ? ' ' + convert(rest) : '');
                }
                
                if (n < 1000000000) {
                    const million = Math.floor(n / 1000000);
                    const rest = n % 1000000;
                    return (million === 1 ? 'un million' : convert(million) + ' millions') + (rest > 0 ? ' ' + convert(rest) : '');
                }
                
                const billion = Math.floor(n / 1000000000);
                const rest = n % 1000000000;
                return (billion === 1 ? 'un milliard' : convert(billion) + ' milliards') + (rest > 0 ? ' ' + convert(rest) : '');
            }
            
            result = convert(total);
            result = result.charAt(0).toUpperCase() + result.slice(1);
            
            // Gérer le pluriel de franc
            if (result.endsWith('un')) {
                result = result + ' franc CFA';
            } else {
                result = result + ' francs CFA';
            }
            
            return result;
        }
        
        // Utiliser la version simple pour éviter les erreurs
        function numberToFrenchWords(num) {
            return numberToFrenchWordsSimple(num);
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Définir les dates par défaut
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            document.getElementById('due-date').value = nextWeek;
            
            // Configurer le toggle WhatsApp automatique
            const autoWhatsAppToggle = document.getElementById('auto-whatsapp');
            autoWhatsAppToggle.addEventListener('change', function() {
                autoWhatsAppEnabled = this.checked;
            });
            
            // Charger les données sauvegardées
            loadSavedData();
            
            // Initialiser les signatures tactiles
            initSignaturePads();
            
            // Configurer les événements
            setupEventListeners();
            
            // Générer un aperçu initial
            updateInvoicePreview();
            
            // Test de la fonction de conversion
            console.log("Test conversion:", numberToFrenchWords(1234567));
        });
        
        // Initialiser les pads de signature tactile
        function initSignaturePads() {
            // Initialiser les canvas pour les signatures
            clientSignatureCanvas = document.getElementById('client-signature-canvas');
            ownerSignatureCanvas = document.getElementById('owner-signature-canvas');
            
            // Obtenir les contextes
            clientSignatureCtx = clientSignatureCanvas.getContext('2d');
            ownerSignatureCtx = ownerSignatureCanvas.getContext('2d');
            
            // Configurer les canvas
            setupCanvas(clientSignatureCanvas, clientSignatureCtx, 'client');
            setupCanvas(ownerSignatureCanvas, ownerSignatureCtx, 'owner');
            
            // Charger les signatures sauvegardées
            loadSavedSignatures();
            
            // Configurer les boutons de signature
            setupSignatureButtons();
        }
        
        // Configurer un canvas de signature
        function setupCanvas(canvas, ctx, padType) {
            // Redimensionner le canvas
            function resizeCanvas() {
                const container = canvas.parentElement;
                const rect = container.getBoundingClientRect();
                
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                clearCanvas(canvas, ctx);
            }
            
            // Initialiser la taille
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Configurer le style du tracé
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#006400';
            
            // Événements pour le dessin tactile
            setupDrawingEvents(canvas, ctx, padType);
        }
        
        // Configurer les événements de dessin tactile
        function setupDrawingEvents(canvas, ctx, padType) {
            // Fonction pour obtenir les coordonnées
            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                let x, y;
                
                if (e.type.includes('touch')) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.offsetX;
                    y = e.offsetY;
                }
                
                return { x, y };
            }
            
            // Démarrer le dessin
            function startDrawing(e) {
                e.preventDefault();
                isDrawing = true;
                currentSignaturePad = padType;
                
                const pos = getCoordinates(e);
                lastX = pos.x;
                lastY = pos.y;
                
                // Masquer les instructions
                const instructions = canvas.parentElement.querySelector('.signature-instructions');
                if (instructions) {
                    instructions.style.opacity = '0';
                }
                
                // Commencer un nouveau tracé
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            }
            
            // Dessiner
            function draw(e) {
                e.preventDefault();
                if (!isDrawing || currentSignaturePad !== padType) return;
                
                const pos = getCoordinates(e);
                const currentX = pos.x;
                const currentY = pos.y;
                
                // Dessiner la ligne
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                
                // Mettre à jour la position
                lastX = currentX;
                lastY = currentY;
            }
            
            // Arrêter le dessin
            function stopDrawing() {
                if (!isDrawing || currentSignaturePad !== padType) return;
                
                isDrawing = false;
                currentSignaturePad = null;
                ctx.closePath();
                
                // Sauvegarder automatiquement la signature
                setTimeout(() => saveSignature(padType), 500);
            }
            
            // Événements tactiles (mobile)
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Événements souris (desktop)
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }
        
        // Effacer un canvas de signature
        function clearCanvas(canvas, ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#006400';
            ctx.lineWidth = 2;
        }
        
        // Configurer les boutons de signature
        function setupSignatureButtons() {
            // Boutons d'effacement
            document.querySelectorAll('.signature-clear').forEach(btn => {
                btn.addEventListener('click', function() {
                    const padType = this.getAttribute('data-pad');
                    clearSignature(padType);
                });
            });
            
            // Boutons de sauvegarde
            document.querySelectorAll('.signature-save').forEach(btn => {
                btn.addEventListener('click', function() {
                    const padType = this.getAttribute('data-pad');
                    saveSignature(padType, true);
                });
            });
        }
        
        // Effacer une signature
        function clearSignature(padType) {
            if (padType === 'client') {
                clearCanvas(clientSignatureCanvas, clientSignatureCtx);
                const instructions = clientSignatureCanvas.parentElement.querySelector('.signature-instructions');
                if (instructions) instructions.style.opacity = '1';
                localStorage.removeItem('clientSignature');
                updateInvoicePreview();
            } else if (padType === 'owner') {
                clearCanvas(ownerSignatureCanvas, ownerSignatureCtx);
                const instructions = ownerSignatureCanvas.parentElement.querySelector('.signature-instructions');
                if (instructions) instructions.style.opacity = '1';
                localStorage.removeItem('ownerSignature');
                updateInvoicePreview();
            }
        }
        
        // Sauvegarder une signature
        function saveSignature(padType, showNotification = false) {
            let canvas, signatureId;
            
            if (padType === 'client') {
                canvas = clientSignatureCanvas;
                signatureId = 'clientSignature';
            } else if (padType === 'owner') {
                canvas = ownerSignatureCanvas;
                signatureId = 'ownerSignature';
            } else {
                return;
            }
            
            // Sauvegarder l'image de la signature
            const dataURL = canvas.toDataURL('image/png');
            localStorage.setItem(signatureId, dataURL);
            
            // Mettre à jour l'aperçu de la facture
            updateInvoicePreview();
        }
        
        // Charger les signatures sauvegardées
        function loadSavedSignatures() {
            // Charger la signature du client
            const savedClientSignature = localStorage.getItem('clientSignature');
            if (savedClientSignature) {
                loadImageToCanvas(savedClientSignature, clientSignatureCanvas, clientSignatureCtx);
            }
            
            // Charger la signature ESODI
            const savedOwnerSignature = localStorage.getItem('ownerSignature');
            if (savedOwnerSignature) {
                loadImageToCanvas(savedOwnerSignature, ownerSignatureCanvas, ownerSignatureCtx);
            }
        }
        
        // Charger une image dans un canvas
        function loadImageToCanvas(imageData, canvas, ctx) {
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const instructions = canvas.parentElement.querySelector('.signature-instructions');
                if (instructions) {
                    instructions.style.opacity = '0';
                }
            };
            img.src = imageData;
        }
        
        // Obtenir l'URL de données d'une signature
        function getSignatureDataURL(padType) {
            if (padType === 'client') {
                return localStorage.getItem('clientSignature');
            } else if (padType === 'owner') {
                return localStorage.getItem('ownerSignature');
            }
            return null;
        }
        
        // Configuration des écouteurs d'événements
        function setupEventListeners() {
            // Navigation par onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const target = this.getAttribute('data-tab');
                    
                    // Désactiver tous les onglets
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Activer l'onglet cible
                    this.classList.add('active');
                    document.getElementById(`${target}-tab`).classList.add('active');
                });
            });
            
            // Bouton "Nouvelle Facture"
            document.querySelectorAll('.go-to-client').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    document.querySelector('[data-tab="client"]').classList.add('active');
                    document.getElementById('client-tab').classList.add('active');
                });
            });
            
            // Sauvegarder les informations du propriétaire
            document.getElementById('save-owner').addEventListener('click', saveOwnerInfo);
            
            // Ajouter un article
            document.getElementById('add-item').addEventListener('click', addInvoiceItem);
            
            // Générer la facture
            document.getElementById('generate-invoice').addEventListener('click', generateInvoice);
            
            // Sauvegarder et envoyer la facture
            document.getElementById('save-invoice').addEventListener('click', saveAndSendInvoice);
            
            // Effacer le formulaire
            document.getElementById('clear-form').addEventListener('click', clearForm);
        }
        
        // Sauvegarder les informations du propriétaire
        function saveOwnerInfo() {
            ownerInfo = {
                name: document.getElementById('owner-name').value,
                phone: document.getElementById('owner-phone').value,
                email: document.getElementById('owner-email').value,
                address: document.getElementById('owner-address').value,
                siret: document.getElementById('owner-siret').value,
                logo: "ESODI"
            };
            
            // Sauvegarder dans localStorage
            localStorage.setItem('invoiceOwnerInfo', JSON.stringify(ownerInfo));
            
            // Afficher un message de confirmation
            const statusEl = document.getElementById('owner-status');
            statusEl.textContent = 'Informations ESODI enregistrées !';
            statusEl.className = 'status-message status-success';
            statusEl.style.display = 'block';
            
            // Masquer le message après 3 secondes
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
        
        // Charger les données sauvegardées
        function loadSavedData() {
            // Charger les informations du propriétaire
            const savedOwnerInfo = localStorage.getItem('invoiceOwnerInfo');
            if (savedOwnerInfo) {
                const loadedInfo = JSON.parse(savedOwnerInfo);
                ownerInfo.address = loadedInfo.address || "";
                ownerInfo.siret = loadedInfo.siret || "";
                document.getElementById('owner-address').value = ownerInfo.address;
                document.getElementById('owner-siret').value = ownerInfo.siret;
            }
            
            // Charger les articles de la dernière facture
            const savedItems = localStorage.getItem('invoiceLastItems');
            if (savedItems) {
                invoiceItems = JSON.parse(savedItems);
                renderItemsListMobile();
            }
        }
        
        // Ajouter un article à la facture
        function addInvoiceItem() {
            const description = document.getElementById('item-description').value;
            const quantity = parseInt(document.getElementById('item-quantity').value);
            const price = parseFloat(document.getElementById('item-price').value);
            const tax = parseInt(document.getElementById('item-tax').value);
            
            if (!description || quantity <= 0 || price < 0) {
                showInvoiceStatus('Veuillez remplir correctement tous les champs de l\'article', 'error');
                return;
            }
            
            const item = {
                id: Date.now(),
                description,
                quantity,
                price,
                tax
            };
            
            invoiceItems.push(item);
            renderItemsListMobile();
            updateInvoicePreview();
            
            // Réinitialiser les champs d'article
            document.getElementById('item-description').value = '';
            document.getElementById('item-quantity').value = 1;
            document.getElementById('item-price').value = 5000;
            document.getElementById('item-tax').value = 10;
        }
        
        // Afficher la liste des articles (version mobile)
        function renderItemsListMobile() {
            const itemsList = document.getElementById('items-list-mobile');
            itemsList.innerHTML = '';
            
            if (invoiceItems.length === 0) {
                itemsList.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px; color: #999; background: #f9f9f9; border-radius: 12px; border: 2px dashed #ddd;">
                        <i class="fas fa-box-open" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p style="font-size: 16px; font-weight: 500;">Aucun article ajouté</p>
                        <p style="font-size: 14px; margin-top: 5px;">Ajoutez votre premier article ci-dessus</p>
                    </div>
                `;
                return;
            }
            
            invoiceItems.forEach(item => {
                const totalHT = item.quantity * item.price;
                const totalTTC = totalHT + (totalHT * (item.tax / 100));
                
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-card-header">
                        <div class="item-card-title">${item.description}</div>
                        <div class="item-card-actions">
                            <button onclick="removeItem(${item.id})" style="background: #ef4444; color: white; padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="item-card-details">
                        <div class="item-card-detail">
                            <span class="item-card-label">Quantité</span>
                            <span>${item.quantity}</span>
                        </div>
                        <div class="item-card-detail">
                            <span class="item-card-label">Prix unitaire</span>
                            <span>${formatFCFA(item.price)}</span>
                        </div>
                        <div class="item-card-detail">
                            <span class="item-card-label">TVA</span>
                            <span>${item.tax}%</span>
                        </div>
                        <div class="item-card-detail">
                            <span class="item-card-label">Total TTC</span>
                            <span style="font-weight: 600; color: #006400;">${formatFCFA(totalTTC)}</span>
                        </div>
                    </div>
                `;
                itemsList.appendChild(card);
            });
        }
        
        // Supprimer un article
        function removeItem(id) {
            invoiceItems = invoiceItems.filter(item => item.id !== id);
            renderItemsListMobile();
            updateInvoicePreview();
        }
        
        // Générer un aperçu de la facture (version mobile)
        function updateInvoicePreview() {
            const previewEl = document.getElementById('invoice-preview-content');
            
            // Calculer les totaux
            let subtotal = 0;
            let taxAmount = 0;
            let total = 0;
            
            invoiceItems.forEach(item => {
                const itemTotal = item.quantity * item.price;
                subtotal += itemTotal;
                taxAmount += itemTotal * (item.tax / 100);
            });
            
            total = subtotal + taxAmount;
            
            // Convertir le total en lettres
            const totalInWords = numberToFrenchWords(total);
            
            // Obtenir les signatures
            const clientSignatureData = getSignatureDataURL('client');
            const ownerSignatureData = getSignatureDataURL('owner');
            
            // Créer l'aperçu mobile
            previewEl.innerHTML = `
                <div class="invoice-header">
                    <div>
                        <div class="company-logo">
                            <div class="logo-preview">ES</div>
                            <div>
                                <h3 style="font-size: 18px; color: #006400;">${ownerInfo.name}</h3>
                                <p style="font-size: 14px;">${ownerInfo.address || 'Adresse à définir'}</p>
                            </div>
                        </div>
                        <p style="font-size: 14px; margin-top: 5px;">
                            <i class="fas fa-phone"></i> ${ownerInfo.phone}<br>
                            <i class="fas fa-envelope"></i> ${ownerInfo.email}
                        </p>
                    </div>
                </div>
                
                <div class="invoice-details">
                    <div style="flex: 1;">
                        <h4 style="font-size: 16px; margin-bottom: 10px; color: #006400;">Facturé à:</h4>
                        <p style="font-size: 15px; margin-bottom: 5px;"><strong>${document.getElementById('client-name').value || 'Nom du client'}</strong></p>
                        <p style="font-size: 14px;">${document.getElementById('client-phone').value || ''}</p>
                        ${document.getElementById('client-address').value ? `<p style="font-size: 14px;">${document.getElementById('client-address').value}</p>` : ''}
                    </div>
                    
                    <div style="flex: 1;">
                        <h4 style="font-size: 16px; margin-bottom: 10px; color: #006400;">Facture:</h4>
                        <p style="font-size: 14px; margin-bottom: 3px;"><strong>N°:</strong> ${document.getElementById('invoice-number').value || 'FACT-ESODI-XXXX-001'}</p>
                        <p style="font-size: 14px; margin-bottom: 3px;"><strong>Date:</strong> ${document.getElementById('invoice-date').value || new Date().toLocaleDateString('fr-FR')}</p>
                        <p style="font-size: 14px;"><strong>Échéance:</strong> ${document.getElementById('due-date').value || new Date().toLocaleDateString('fr-FR')}</p>
                    </div>
                </div>
                
                <div class="invoice-items-mobile">
                    <h4 style="font-size: 16px; margin-bottom: 15px; color: #006400;">Articles:</h4>
                    ${invoiceItems.length > 0 ? invoiceItems.map(item => {
                        const itemTotal = item.quantity * item.price;
                        const itemTotalTTC = itemTotal + (itemTotal * (item.tax / 100));
                        return `
                            <div class="invoice-item-mobile">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <strong style="font-size: 15px;">${item.description}</strong>
                                    <span style="font-weight: 600; color: #006400;">${formatFCFA(itemTotalTTC)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 13px; color: #666;">
                                    <span>${item.quantity} × ${formatFCFA(item.price)}</span>
                                    <span>TVA: ${item.tax}%</span>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p style="text-align: center; color: #999; padding: 20px;">Aucun article ajouté</p>'}
                </div>
                
                <div class="invoice-totals">
                    <div class="total-row">
                        <span>Sous-total HT:</span>
                        <span>${formatFCFA(subtotal)}</span>
                    </div>
                    <div class="total-row">
                        <span>TVA:</span>
                        <span>${formatFCFA(taxAmount)}</span>
                    </div>
                    <div class="total-row">
                        <span><strong>Total TTC:</strong></span>
                        <span><strong>${formatFCFA(total)}</strong></span>
                    </div>
                </div>
                
                <div class="amount-in-words">
                    <p><strong>Arrêtée à la somme de :</strong><br>${totalInWords}</p>
                </div>
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px dashed #ddd;">
                    <h4 style="font-size: 16px; margin-bottom: 15px; color: #006400;">Signatures:</h4>
                    
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Client:</p>
                            ${clientSignatureData ? 
                                `<img src="${clientSignatureData}" class="signature-preview-img" alt="Signature client">` :
                                '<p style="color: #999; font-size: 13px;">Signature non ajoutée</p>'
                            }
                        </div>
                        
                        <div>
                            <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ESODI:</p>
                            ${ownerSignatureData ? 
                                `<img src="${ownerSignatureData}" class="signature-preview-img" alt="Signature ESODI">` :
                                '<p style="color: #999; font-size: 13px;">Signature non ajoutée</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Générer la facture complète
        function generateInvoice() {
            // Valider les champs obligatoires
            const clientName = document.getElementById('client-name').value;
            const clientPhone = document.getElementById('client-phone').value;
            
            if (!clientName || !clientPhone) {
                showInvoiceStatus('Remplissez le nom et téléphone du client', 'error');
                return;
            }
            
            if (invoiceItems.length === 0) {
                showInvoiceStatus('Ajoutez au moins un article', 'error');
                return;
            }
            
            // Mettre à jour l'aperçu
            updateInvoicePreview();
            
            showInvoiceStatus('Aperçu actualisé !', 'success');
        }
        
        // Sauvegarder ET envoyer la facture par WhatsApp
        function saveAndSendInvoice() {
            // Valider les champs obligatoires
            const clientName = document.getElementById('client-name').value;
            const clientPhone = document.getElementById('client-phone').value;
            
            if (!clientName || !clientPhone) {
                showInvoiceStatus('Nom et téléphone client requis', 'error');
                return;
            }
            
            if (invoiceItems.length === 0) {
                showInvoiceStatus('Ajoutez des articles d\'abord', 'error');
                return;
            }
            
            // Sauvegarder les signatures
            saveSignature('client');
            saveSignature('owner');
            
            // Obtenir les données des signatures
            const clientSigData = getSignatureDataURL('client');
            const ownerSigData = getSignatureDataURL('owner');
            
            // Créer l'objet facture
            const invoice = {
                id: Date.now(),
                number: document.getElementById('invoice-number').value,
                date: document.getElementById('invoice-date').value,
                dueDate: document.getElementById('due-date').value,
                client: {
                    name: clientName,
                    phone: clientPhone,
                    email: document.getElementById('client-email').value,
                    address: document.getElementById('client-address').value
                },
                items: [...invoiceItems],
                paymentMethod: document.getElementById('payment-method').value,
                notes: document.getElementById('invoice-notes').value,
                clientSignature: clientSigData,
                ownerSignature: ownerSigData,
                currency: "FCFA",
                createdAt: new Date().toISOString()
            };
            
            // Sauvegarder dans localStorage
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            savedInvoices.push(invoice);
            localStorage.setItem('savedInvoices', JSON.stringify(savedInvoices));
            
            // Sauvegarder les articles
            localStorage.setItem('invoiceLastItems', JSON.stringify(invoiceItems));
            
            // Envoyer par WhatsApp
            sendWhatsAppMessage(invoice);
            
            showInvoiceStatus(`Facture envoyée sur WhatsApp !`, 'success');
        }
        
        // Fonction pour envoyer le message WhatsApp avec montant en lettres
        function sendWhatsAppMessage(invoice) {
            // Calculer les totaux
            let subtotal = 0;
            let taxAmount = 0;
            invoice.items.forEach(item => {
                const itemTotal = item.quantity * item.price;
                subtotal += itemTotal;
                taxAmount += itemTotal * (item.tax / 100);
            });
            const total = subtotal + taxAmount;
            const totalInWords = numberToFrenchWords(total);
            
            // Message WhatsApp
            let message = `*📋 FACTURE ESODI - ${invoice.number}*%0A%0A`;
            message += `*Bonjour ${invoice.client.name}*,%0A%0A`;
            message += `Voici votre facture :%0A%0A`;
            
            message += `*DÉTAILS*%0A`;
            message += `N°: ${invoice.number}%0A`;
            message += `Date: ${invoice.date}%0A`;
            message += `Échéance: ${invoice.dueDate}%0A`;
            message += `Paiement: ${invoice.paymentMethod}%0A%0A`;
            
            message += `*ARTICLES*%0A`;
            invoice.items.forEach((item, index) => {
                const itemTotal = item.quantity * item.price;
                const itemTotalTTC = itemTotal + (itemTotal * (item.tax / 100));
                message += `${index + 1}. ${item.description}%0A`;
                message += `   ${item.quantity} × ${formatFCFA(item.price)}%0A`;
                message += `   TVA ${item.tax}% → ${formatFCFA(itemTotalTTC)}%0A%0A`;
            });
            
            message += `*TOTAUX*%0A`;
            message += `Sous-total HT: ${formatFCFA(subtotal)}%0A`;
            message += `TVA: ${formatFCFA(taxAmount)}%0A`;
            message += `*TOTAL TTC: ${formatFCFA(total)}*%0A%0A`;
            
            message += `*MONTANT EN LETTRES*%0A`;
            message += `${totalInWords}%0A%0A`;
            
            if (invoice.notes) {
                message += `*NOTES*%0A`;
                message += `${invoice.notes}%0A%0A`;
            }
            
            message += `*ESODI*%0A`;
            message += `📞 ${ownerInfo.phone}%0A`;
            message += `📧 ${ownerInfo.email}%0A`;
            if (ownerInfo.address) message += `📍 ${ownerInfo.address}%0A%0A`;
            
            message += `*PAIEMENT*%0A`;
            message += `Mobile Money: *${ownerInfo.phone}*%0A%0A`;
            
            message += `Merci pour votre confiance !%0A`;
            message += `*L'équipe ESODI*`;
            
            // Formater le numéro de téléphone
            const formattedPhone = invoice.client.phone.replace(/\s+/g, '').replace('+', '');
            
            // Ouvrir WhatsApp
            const whatsappURL = `https://wa.me/${formattedPhone}?text=${message}`;
            window.open(whatsappURL, '_blank');
        }
        
        // Effacer le formulaire
        function clearForm() {
            if (confirm('Créer une nouvelle facture ?')) {
                // Réinitialiser les champs du client
                document.getElementById('client-name').value = '';
                document.getElementById('client-phone').value = '';
                document.getElementById('client-email').value = '';
                document.getElementById('client-address').value = '';
                
                // Numéro de facture incrémenté
                const nextInvoiceNumber = parseInt(localStorage.getItem('lastInvoiceNumber') || '0') + 1;
                localStorage.setItem('lastInvoiceNumber', nextInvoiceNumber);
                document.getElementById('invoice-number').value = `FACT-ESODI-${new Date().getFullYear()}-${nextInvoiceNumber.toString().padStart(3, '0')}`;
                
                // Dates
                const today = new Date().toISOString().split('T')[0];
                const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                document.getElementById('invoice-date').value = today;
                document.getElementById('due-date').value = nextWeek;
                
                document.getElementById('invoice-notes').value = '';
                
                // Réinitialiser les articles
                invoiceItems = [];
                renderItemsListMobile();
                
                // Mettre à jour l'aperçu
                updateInvoicePreview();
                
                showInvoiceStatus('Nouvelle facture prête !', 'success');
            }
        }
        
        // Afficher un message de statut
        function showInvoiceStatus(message, type) {
            const statusEl = document.getElementById('invoice-status');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 4000);
        }
    </script>
</body>
</html>