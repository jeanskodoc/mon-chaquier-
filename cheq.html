<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ESODI Facturation - Tableau de Bord</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* RESET MOBILE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }
        
        html {
            font-size: 16px;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            line-height: 1.5;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        /* CONTAINER MOBILE */
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            position: relative;
        }
        
        /* HEADER MOBILE */
        header {
            background: linear-gradient(135deg, #006400 0%, #228B22 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: relative;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .logo-icon {
            font-size: 28px;
            background: white;
            color: #006400;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
            flex-shrink: 0;
        }
        
        header h1 {
            font-size: 20px;
            margin-bottom: 5px;
            line-height: 1.3;
        }
        
        header p {
            opacity: 0.9;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .whatsapp-auto-notice {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        /* TABS MOBILE */
        .tabs {
            display: flex;
            background-color: #f0f4f8;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 16px 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 90px;
        }
        
        .tab.active {
            background-color: white;
            color: #006400;
            border-bottom: 3px solid #006400;
        }
        
        /* TAB CONTENT MOBILE */
        .tab-content {
            display: none;
            padding: 20px 15px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* FORM SECTIONS MOBILE */
        .form-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 17px;
            color: #006400;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            width: 100%;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 14px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px 12px;
            border: 1.5px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s;
            background: #fafafa;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #006400;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
            background: white;
        }
        
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23006400' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* BOUTONS MOBILE */
        .btn {
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-color: #006400;
            color: white;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-info {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        /* PREVIEW FACTURE MOBILE */
        .invoice-preview {
            background-color: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border: 1.5px solid #e5e7eb;
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .invoice-header {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #006400;
        }
        
        .company-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .logo-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(135deg, #006400 0%, #228B22 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .invoice-details {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .invoice-items-mobile {
            margin-bottom: 20px;
        }
        
        .invoice-item-mobile {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #eee;
        }
        
        .invoice-totals {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
            font-size: 15px;
        }
        
        .total-row:last-child {
            font-size: 17px;
            font-weight: 700;
            color: #006400;
            border-bottom: none;
        }
        
        .amount-in-words {
            background-color: #f0fff0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #006400;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .currency-badge {
            background-color: #006400;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
            display: inline-block;
        }
        
        /* SIGNATURE MOBILE */
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }
        
        .signature-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 15px;
        }
        
        .signature-box {
            width: 100%;
        }
        
        .signature-pad-container {
            width: 100%;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            margin-top: 8px;
            background-color: white;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }
        
        .signature-pad {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            cursor: crosshair;
        }
        
        .signature-instructions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            text-align: center;
            padding: 20px;
            z-index: 1;
            pointer-events: none;
        }
        
        .signature-instructions i {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .signature-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-clear {
            background-color: #ef4444;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        
        .signature-save {
            background-color: #006400;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }
        
        /* STATUS MESSAGES MOBILE */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        /* WHATSAPP AUTO OPTION MOBILE */
        .whatsapp-auto-option {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #c8e6c9;
        }
        
        .auto-whatsapp-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 10px 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #25D366;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* FOOTER MOBILE */
        footer {
            text-align: center;
            padding: 20px 15px;
            margin-top: 25px;
            color: #666;
            font-size: 12px;
            line-height: 1.5;
            border-top: 1px solid #eee;
        }
        
        /* CARD STYLE FOR ITEMS */
        .item-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .item-card-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            flex: 1;
        }
        
        .item-card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .item-card-detail {
            display: flex;
            flex-direction: column;
        }
        
        .item-card-label {
            font-weight: 500;
            color: #888;
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        /* SIGNATURE PREVIEW */
        .signature-preview-img {
            max-width: 200px;
            max-height: 80px;
            border: 1px solid #ccc;
            padding: 5px;
            background: white;
            border-radius: 5px;
            margin-top: 5px;
        }
        
        /* FILTER SECTION */
        .filter-section {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        
        .filter-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .invoice-list {
            margin-top: 20px;
        }
        
        .invoice-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }
        
        .invoice-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .invoice-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-card-title {
            font-weight: 600;
            color: #006400;
            font-size: 18px;
            flex: 1;
        }
        
        .invoice-card-actions {
            display: flex;
            gap: 10px;
        }
        
        .invoice-card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .invoice-card-detail {
            display: flex;
            flex-direction: column;
        }
        
        .invoice-card-label {
            font-weight: 500;
            color: #888;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .invoice-card-total {
            background-color: #f0fff0;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            color: #006400;
            border-left: 4px solid #006400;
        }
        
        .action-button-small {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }
        
        .action-button-small:active {
            transform: scale(0.98);
        }
        
        /* ANALYTICS SECTION */
        .analytics-section {
            margin-top: 20px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #006400;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 12px;
            color: #10b981;
            font-weight: 600;
        }
        
        .stat-change.negative {
            color: #ef4444;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            height: 300px;
            position: relative;
        }
        
        /* PRINT STYLES - CORRIGÉ */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-area, .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                padding: 20px;
                margin: 0;
                box-shadow: none;
                border: none;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 3px solid #006400;
                padding-bottom: 20px;
            }
            
            .print-logo {
                font-size: 48px;
                background: #006400;
                color: white;
                width: 80px;
                height: 80px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 15px;
                font-weight: bold;
            }
            
            .print-section {
                margin-bottom: 25px;
                page-break-inside: avoid;
            }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
            }
            
            .print-table th {
                background-color: #f0f0f0;
                padding: 12px;
                text-align: left;
                border: 1px solid #ddd;
                font-weight: bold;
            }
            
            .print-table td {
                padding: 12px;
                border: 1px solid #ddd;
            }
            
            .print-totals {
                background-color: #f9f9f9;
                padding: 20px;
                border: 2px solid #006400;
                margin-top: 30px;
                page-break-inside: avoid;
            }
            
            .print-signatures {
                margin-top: 50px;
                padding-top: 30px;
                border-top: 2px dashed #666;
                page-break-inside: avoid;
            }
        }
        
        /* MEDIA QUERIES */
        @media (min-width: 480px) {
            body {
                padding: 15px;
            }
            
            header h1 {
                font-size: 22px;
            }
            
            .tab {
                font-size: 15px;
                padding: 16px 12px;
            }
            
            .btn {
                padding: 16px 24px;
            }
            
            .analytics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                max-width: 95%;
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1;
                min-width: calc(50% - 10px);
            }
            
            .signature-container {
                flex-direction: row;
            }
            
            .signature-box {
                flex: 1;
            }
            
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .btn {
                width: auto;
                flex: 1;
                min-width: calc(50% - 10px);
            }
            
            .invoice-header {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .invoice-details {
                flex-direction: row;
            }
            
            .filter-row {
                flex-direction: row;
            }
            
            .analytics-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .action-buttons-row {
                display: flex;
                gap: 10px;
            }
            
            .action-button-small {
                min-width: auto;
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo-icon">
                    ES
                </div>
                <div style="flex: 1; min-width: 0;">
                    <h1>ESODI Facturation - Tableau de Bord</h1>
                    <p>Créez, gérez et analysez vos factures en FCFA</p>
                    <div class="whatsapp-auto-notice">
                        <i class="fab fa-whatsapp"></i> Envoi WhatsApp automatique
                    </div>
                </div>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="owner">ESODI</div>
            <div class="tab" data-tab="client">Facture</div>
            <div class="tab" data-tab="history">Historique</div>
            <div class="tab" data-tab="analytics">Analyse</div>
        </div>
        
        <div id="owner-tab" class="tab-content active">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-building"></i> Entreprise ESODI</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="owner-name">Nom entreprise</label>
                        <input type="text" id="owner-name" value="ESODI" readonly>
                    </div>
                    <div class="form-group">
                        <label for="owner-phone">Téléphone WhatsApp</label>
                        <input type="tel" id="owner-phone" value="+22892871605" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="owner-email">Email</label>
                        <input type="email" id="owner-email" value="jeanskodoc22@gmail.com" readonly>
                    </div>
                    <div class="form-group">
                        <label for="owner-address">Adresse</label>
                        <input type="text" id="owner-address" placeholder="Saisir l'adresse ESODI">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="owner-siret">N° RCCM</label>
                        <input type="text" id="owner-siret" placeholder="Numéro RCCM">
                    </div>
                </div>
                
                <div class="whatsapp-auto-option">
                    <h3 style="font-size: 16px; margin-bottom: 10px; color: #006400;">
                        <i class="fab fa-whatsapp"></i> WhatsApp Automatique
                    </h3>
                    
                    <div class="auto-whatsapp-toggle">
                        <span style="font-weight: 600; font-size: 15px;">Envoi automatique</span>
                        <div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-whatsapp" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <p style="margin-top: 10px; font-size: 13px; color: #555; line-height: 1.4;">
                        <i class="fas fa-info-circle"></i> La facture sera automatiquement envoyée au client par WhatsApp lors de l'enregistrement.
                    </p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="save-owner">
                    <i class="fas fa-save"></i> Sauvegarder
                </button>
                <button class="btn btn-success go-to-client">
                    <i class="fas fa-file-invoice"></i> Nouvelle Facture
                </button>
            </div>
            
            <div id="owner-status" class="status-message"></div>
        </div>
        
        <div id="client-tab" class="tab-content">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-user"></i> Client</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-name">Nom du client *</label>
                        <input type="text" id="client-name" placeholder="Nom complet ou entreprise">
                    </div>
                    <div class="form-group">
                        <label for="client-phone">Téléphone WhatsApp *</label>
                        <input type="tel" id="client-phone" placeholder="Ex: +228 90 12 34 56">
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
                            La facture sera envoyée à ce numéro
                        </small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-email">Email (optionnel)</label>
                        <input type="email" id="client-email" placeholder="client@email.com">
                    </div>
                    <div class="form-group">
                        <label for="client-address">Adresse (optionnel)</label>
                        <input type="text" id="client-address" placeholder="Adresse du client">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-receipt"></i> Détails Facture</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoice-number">N° Facture *</label>
                        <input type="text" id="invoice-number" value="FACT-ESODI-2023-001">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoice-date">Date facturation *</label>
                        <input type="date" id="invoice-date">
                    </div>
                    <div class="form-group">
                        <label for="due-date">Date échéance *</label>
                        <input type="date" id="due-date">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-method">Méthode paiement</label>
                        <select id="payment-method">
                            <option value="Mobile Money" selected>Mobile Money</option>
                            <option value="Virement bancaire">Virement bancaire</option>
                            <option value="Espèces">Espèces</option>
                            <option value="Chèque">Chèque</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="invoice-notes">Notes (optionnel)</label>
                        <textarea id="invoice-notes" rows="2" placeholder="Notes additionnelles..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-boxes"></i> Articles <span class="currency-badge">FCFA</span></h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="item-description">Description *</label>
                        <input type="text" id="item-description" placeholder="Nom de l'article ou service">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="item-quantity">Quantité *</label>
                        <input type="number" id="item-quantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="item-price">Prix unitaire <span class="currency-badge">FCFA</span></label>
                        <input type="number" id="item-price" min="0" step="100" value="5000">
                    </div>
                    <div class="form-group">
                        <label for="item-tax">TVA (%)</label>
                        <select id="item-tax">
                            <option value="0">0%</option>
                            <option value="10" selected>10%</option>
                            <option value="18">18%</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="add-item" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> Ajouter l'article
                </button>
                
                <div id="items-list-mobile" style="margin-top: 20px;">
                    <!-- Articles sous forme de cartes pour mobile -->
                </div>
            </div>
            
            <div class="signature-section">
                <h2 class="section-title"><i class="fas fa-signature"></i> Signatures Tactiles</h2>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    <i class="fas fa-fingerprint"></i> Utilisez votre doigt pour signer directement sur l'écran.
                </p>
                
                <div class="signature-container">
                    <div class="signature-box">
                        <label style="font-size: 15px;">
                            <i class="fas fa-user"></i> Signature du client
                        </label>
                        <div class="signature-pad-container" id="client-signature-container">
                            <div class="signature-instructions">
                                <i class="fas fa-hand-pointer"></i>
                                <span>Touchez et tracez votre signature</span>
                            </div>
                            <canvas class="signature-pad" id="client-signature-canvas"></canvas>
                        </div>
                        <div class="signature-actions">
                            <button class="signature-clear" data-pad="client">
                                <i class="fas fa-eraser"></i> Effacer
                            </button>
                            <button class="signature-save" data-pad="client">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                    </div>
                    
                    <div class="signature-box">
                        <label style="font-size: 15px;">
                            <i class="fas fa-building"></i> Signature ESODI
                        </label>
                        <div class="signature-pad-container" id="owner-signature-container">
                            <div class="signature-instructions">
                                <i class="fas fa-hand-pointer"></i>
                                <span>Touchez et tracez votre signature</span>
                            </div>
                            <canvas class="signature-pad" id="owner-signature-canvas"></canvas>
                        </div>
                        <div class="signature-actions">
                            <button class="signature-clear" data-pad="owner">
                                <i class="fas fa-eraser"></i> Effacer
                            </button>
                            <button class="signature-save" data-pad="owner">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="invoice-preview">
                <h2 class="section-title"><i class="fas fa-eye"></i> Aperçu Facture</h2>
                <div id="invoice-preview-content">
                    <!-- Aperçu sera généré ici -->
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="generate-invoice">
                    <i class="fas fa-sync-alt"></i> Actualiser Aperçu
                </button>
                <button class="btn btn-success" id="save-invoice">
                    <i class="fas fa-paper-plane"></i> Envoyer Facture
                </button>
                <button class="btn btn-info" id="print-invoice">
                    <i class="fas fa-print"></i> Imprimer Facture
                </button>
                <button class="btn btn-secondary" id="clear-form">
                    <i class="fas fa-redo"></i> Nouvelle
                </button>
            </div>
            
            <div id="invoice-status" class="status-message"></div>
        </div>
        
        <div id="history-tab" class="tab-content">
            <div class="filter-section">
                <h2 class="section-title"><i class="fas fa-search"></i> Filtrer les Factures</h2>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filter-client">Nom du client</label>
                        <input type="text" id="filter-client" placeholder="Rechercher par nom...">
                    </div>
                    <div class="filter-group">
                        <label for="filter-date-from">Date de début</label>
                        <input type="date" id="filter-date-from">
                    </div>
                    <div class="filter-group">
                        <label for="filter-date-to">Date de fin</label>
                        <input type="date" id="filter-date-to">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <button class="btn btn-primary" id="apply-filter" style="margin-top: 10px;">
                            <i class="fas fa-filter"></i> Appliquer le filtre
                        </button>
                        <button class="btn btn-secondary" id="clear-filter" style="margin-top: 10px;">
                            <i class="fas fa-times"></i> Effacer filtre
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="invoice-list" id="invoice-history-list">
                <!-- Liste des factures -->
            </div>
        </div>
        
        <div id="analytics-tab" class="tab-content">
            <div class="analytics-section">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Analyse des Ventes</h2>
                
                <div class="analytics-grid">
                    <div class="stat-card">
                        <h3>Chiffre d'affaires total</h3>
                        <div class="stat-value" id="total-revenue">0 FCFA</div>
                        <div class="stat-change" id="revenue-change">+0% vs mois dernier</div>
                    </div>
                    
                    <div class="stat-card">
                        <h3>Nombre de factures</h3>
                        <div class="stat-value" id="total-invoices">0</div>
                        <div class="stat-change" id="invoices-change">+0% vs mois dernier</div>
                    </div>
                    
                    <div class="stat-card">
                        <h3>Moyenne par facture</h3>
                        <div class="stat-value" id="average-invoice">0 FCFA</div>
                        <div class="stat-change" id="average-change">+0% vs mois dernier</div>
                    </div>
                    
                    <div class="stat-card">
                        <h3>Clients actifs</h3>
                        <div class="stat-value" id="active-clients">0</div>
                        <div class="stat-change" id="clients-change">+0% vs mois dernier</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px;">Évolution du chiffre d'affaires</h3>
                    <canvas id="revenue-chart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px;">Répartition par méthode de paiement</h3>
                    <canvas id="payment-chart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px;">Top 5 clients</h3>
                    <canvas id="clients-chart"></canvas>
                </div>
            </div>
        </div>
        
        <footer>
            <p style="font-weight: 600; margin-bottom: 5px;">ESODI - Facturation Digital</p>
            <p style="font-size: 11px;">WhatsApp: +228 92 87 16 05 | FCFA | Togo</p>
        </footer>
    </div>

    <!-- Zone d'impression cachée -->
    <div id="print-container" style="display: none;">
        <div id="print-content" class="print-area"></div>
    </div>

    <script>
        // Variables globales
        let invoiceItems = [];
        let ownerInfo = {
            name: "ESODI",
            phone: "+22892871605",
            email: "jeanskodoc22@gmail.com",
            address: "",
            siret: "",
            logo: "ESODI"
        };
        
        // Variables pour les signatures
        let clientSignatureCanvas = null;
        let ownerSignatureCanvas = null;
        let clientSignatureCtx = null;
        let ownerSignatureCtx = null;
        let isDrawing = false;
        let currentSignaturePad = null;
        let lastX = 0;
        let lastY = 0;
        
        // Configuration WhatsApp automatique
        let autoWhatsAppEnabled = true;
        
        // Variables pour les graphiques
        let revenueChart = null;
        let paymentChart = null;
        let clientsChart = null;
        
        // Fonction de formatage FCFA
        function formatFCFA(number) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(number) + ' FCFA';
        }
        
        // Fonction de conversion nombre en lettres (version simplifiée)
        function numberToFrenchWords(num) {
            const units = ['zéro', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];
            
            if (num === 0) return 'Zéro francs CFA';
            
            const total = Math.floor(num);
            let result = '';
            
            function convert(n) {
                if (n < 10) return units[n];
                if (n < 20) return teens[n - 10];
                
                if (n < 100) {
                    const ten = Math.floor(n / 10);
                    const unit = n % 10;
                    
                    if (ten === 7) {
                        return 'soixante' + (unit > 0 ? '-' + (unit === 1 ? 'et-' : '') + (unit < 7 ? units[unit] : teens[unit - 10]) : '');
                    }
                    if (ten === 9) {
                        return 'quatre-vingt' + (unit > 0 ? '-' + (unit === 1 ? 'et-' : '') + (unit < 7 ? units[unit] : teens[unit - 10]) : '-dix');
                    }
                    
                    if (ten === 8) {
                        return 'quatre-vingt' + (unit > 0 ? '-' + units[unit] : 's');
                    }
                    
                    return tens[ten] + (unit > 0 ? (unit === 1 ? '-et-' : '-') + units[unit] : '');
                }
                
                if (n < 1000) {
                    const hundred = Math.floor(n / 100);
                    const rest = n % 100;
                    return (hundred === 1 ? 'cent' : units[hundred] + ' cent') + (rest > 0 ? ' ' + convert(rest) : 's');
                }
                
                if (n < 1000000) {
                    const thousand = Math.floor(n / 1000);
                    const rest = n % 1000;
                    return (thousand === 1 ? 'mille' : convert(thousand) + ' mille') + (rest > 0 ? ' ' + convert(rest) : '');
                }
                
                if (n < 1000000000) {
                    const million = Math.floor(n / 1000000);
                    const rest = n % 1000000;
                    return (million === 1 ? 'un million' : convert(million) + ' millions') + (rest > 0 ? ' ' + convert(rest) : '');
                }
                
                const billion = Math.floor(n / 1000000000);
                const rest = n % 1000000000;
                return (billion === 1 ? 'un milliard' : convert(billion) + ' milliards') + (rest > 0 ? ' ' + convert(rest) : '');
            }
            
            result = convert(total);
            result = result.charAt(0).toUpperCase() + result.slice(1);
            
            if (result.endsWith('un')) {
                result = result + ' franc CFA';
            } else {
                result = result + ' francs CFA';
            }
            
            return result;
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Définir les dates par défaut
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            document.getElementById('due-date').value = nextWeek;
            
            // Configurer le toggle WhatsApp automatique
            const autoWhatsAppToggle = document.getElementById('auto-whatsapp');
            autoWhatsAppToggle.addEventListener('change', function() {
                autoWhatsAppEnabled = this.checked;
            });
            
            // Charger les données sauvegardées
            loadSavedData();
            
            // Initialiser les signatures tactiles
            initSignaturePads();
            
            // Configurer les événements
            setupEventListeners();
            
            // Générer un aperçu initial
            updateInvoicePreview();
            
            // Charger l'historique des factures
            loadInvoiceHistory();
            
            // Initialiser les graphiques
            initCharts();
        });
        
        // Initialiser les pads de signature tactile
        function initSignaturePads() {
            // Initialiser les canvas pour les signatures
            clientSignatureCanvas = document.getElementById('client-signature-canvas');
            ownerSignatureCanvas = document.getElementById('owner-signature-canvas');
            
            // Obtenir les contextes
            clientSignatureCtx = clientSignatureCanvas.getContext('2d');
            ownerSignatureCtx = ownerSignatureCanvas.getContext('2d');
            
            // Configurer les canvas
            setupCanvas(clientSignatureCanvas, clientSignatureCtx, 'client');
            setupCanvas(ownerSignatureCanvas, ownerSignatureCtx, 'owner');
            
            // Charger les signatures sauvegardées
            loadSavedSignatures();
            
            // Configurer les boutons de signature
            setupSignatureButtons();
        }
        
        // Configurer un canvas de signature
        function setupCanvas(canvas, ctx, padType) {
            // Redimensionner le canvas
            function resizeCanvas() {
                const container = canvas.parentElement;
                const rect = container.getBoundingClientRect();
                
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                clearCanvas(canvas, ctx);
            }
            
            // Initialiser la taille
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Configurer le style du tracé
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#006400';
            
            // Événements pour le dessin tactile
            setupDrawingEvents(canvas, ctx, padType);
        }
        
        // Configurer les événements de dessin tactile
        function setupDrawingEvents(canvas, ctx, padType) {
            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                let x, y;
                
                if (e.type.includes('touch')) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.offsetX;
                    y = e.offsetY;
                }
                
                return { x, y };
            }
            
            function startDrawing(e) {
                e.preventDefault();
                isDrawing = true;
                currentSignaturePad = padType;
                
                const pos = getCoordinates(e);
                lastX = pos.x;
                lastY = pos.y;
                
                const instructions = canvas.parentElement.querySelector('.signature-instructions');
                if (instructions) {
                    instructions.style.opacity = '0';
                }
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            }
            
            function draw(e) {
                e.preventDefault();
                if (!isDrawing || currentSignaturePad !== padType) return;
                
                const pos = getCoordinates(e);
                const currentX = pos.x;
                const currentY = pos.y;
                
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                
                lastX = currentX;
                lastY = currentY;
            }
            
            function stopDrawing() {
                if (!isDrawing || currentSignaturePad !== padType) return;
                
                isDrawing = false;
                currentSignaturePad = null;
                ctx.closePath();
                
                setTimeout(() => saveSignature(padType), 500);
            }
            
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }
        
        // Effacer un canvas de signature
        function clearCanvas(canvas, ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#006400';
            ctx.lineWidth = 2;
        }
        
        // Configurer les boutons de signature
        function setupSignatureButtons() {
            document.querySelectorAll('.signature-clear').forEach(btn => {
                btn.addEventListener('click', function() {
                    const padType = this.getAttribute('data-pad');
                    clearSignature(padType);
                });
            });
            
            document.querySelectorAll('.signature-save').forEach(btn => {
                btn.addEventListener('click', function() {
                    const padType = this.getAttribute('data-pad');
                    saveSignature(padType, true);
                });
            });
        }
        
        // Effacer une signature
        function clearSignature(padType) {
            if (padType === 'client') {
                clearCanvas(clientSignatureCanvas, clientSignatureCtx);
                const instructions = clientSignatureCanvas.parentElement.querySelector('.signature-instructions');
                if (instructions) instructions.style.opacity = '1';
                localStorage.removeItem('clientSignature');
                updateInvoicePreview();
            } else if (padType === 'owner') {
                clearCanvas(ownerSignatureCanvas, ownerSignatureCtx);
                const instructions = ownerSignatureCanvas.parentElement.querySelector('.signature-instructions');
                if (instructions) instructions.style.opacity = '1';
                localStorage.removeItem('ownerSignature');
                updateInvoicePreview();
            }
        }
        
        // Sauvegarder une signature
        function saveSignature(padType, showNotification = false) {
            let canvas, signatureId;
            
            if (padType === 'client') {
                canvas = clientSignatureCanvas;
                signatureId = 'clientSignature';
            } else if (padType === 'owner') {
                canvas = ownerSignatureCanvas;
                signatureId = 'ownerSignature';
            } else {
                return;
            }
            
            const dataURL = canvas.toDataURL('image/png');
            localStorage.setItem(signatureId, dataURL);
            
            updateInvoicePreview();
        }
        
        // Charger les signatures sauvegardées
        function loadSavedSignatures() {
            const savedClientSignature = localStorage.getItem('clientSignature');
            if (savedClientSignature) {
                loadImageToCanvas(savedClientSignature, clientSignatureCanvas, clientSignatureCtx);
            }
            
            const savedOwnerSignature = localStorage.getItem('ownerSignature');
            if (savedOwnerSignature) {
                loadImageToCanvas(savedOwnerSignature, ownerSignatureCanvas, ownerSignatureCtx);
            }
        }
        
        // Charger une image dans un canvas
        function loadImageToCanvas(imageData, canvas, ctx) {
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const instructions = canvas.parentElement.querySelector('.signature-instructions');
                if (instructions) {
                    instructions.style.opacity = '0';
                }
            };
            img.src = imageData;
        }
        
        // Obtenir l'URL de données d'une signature
        function getSignatureDataURL(padType) {
            if (padType === 'client') {
                return localStorage.getItem('clientSignature');
            } else if (padType === 'owner') {
                return localStorage.getItem('ownerSignature');
            }
            return null;
        }
        
        // Configuration des écouteurs d'événements
        function setupEventListeners() {
            // Navigation par onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const target = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${target}-tab`).classList.add('active');
                    
                    // Si onglet analyse, mettre à jour les graphiques
                    if (target === 'analytics') {
                        updateAnalytics();
                    }
                    
                    // Si onglet historique, charger les factures
                    if (target === 'history') {
                        loadInvoiceHistory();
                    }
                });
            });
            
            // Bouton "Nouvelle Facture"
            document.querySelectorAll('.go-to-client').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    document.querySelector('[data-tab="client"]').classList.add('active');
                    document.getElementById('client-tab').classList.add('active');
                });
            });
            
            // Sauvegarder les informations du propriétaire
            document.getElementById('save-owner').addEventListener('click', saveOwnerInfo);
            
            // Ajouter un article
            document.getElementById('add-item').addEventListener('click', addInvoiceItem);
            
            // Générer la facture
            document.getElementById('generate-invoice').addEventListener('click', generateInvoice);
            
            // Sauvegarder et envoyer la facture
            document.getElementById('save-invoice').addEventListener('click', saveAndSendInvoice);
            
            // Imprimer la facture
            document.getElementById('print-invoice').addEventListener('click', printInvoice);
            
            // Effacer le formulaire
            document.getElementById('clear-form').addEventListener('click', clearForm);
            
            // Filtrer les factures
            document.getElementById('apply-filter').addEventListener('click', applyFilter);
            document.getElementById('clear-filter').addEventListener('click', clearFilter);
            
            // Entrée sur les champs de filtre
            document.getElementById('filter-client').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    applyFilter();
                }
            });
        }
        
        // Sauvegarder les informations du propriétaire
        function saveOwnerInfo() {
            ownerInfo = {
                name: document.getElementById('owner-name').value,
                phone: document.getElementById('owner-phone').value,
                email: document.getElementById('owner-email').value,
                address: document.getElementById('owner-address').value,
                siret: document.getElementById('owner-siret').value,
                logo: "ESODI"
            };
            
            localStorage.setItem('invoiceOwnerInfo', JSON.stringify(ownerInfo));
            
            const statusEl = document.getElementById('owner-status');
            statusEl.textContent = 'Informations ESODI enregistrées !';
            statusEl.className = 'status-message status-success';
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
        
        // Charger les données sauvegardées
        function loadSavedData() {
            const savedOwnerInfo = localStorage.getItem('invoiceOwnerInfo');
            if (savedOwnerInfo) {
                const loadedInfo = JSON.parse(savedOwnerInfo);
                ownerInfo.address = loadedInfo.address || "";
                ownerInfo.siret = loadedInfo.siret || "";
                document.getElementById('owner-address').value = ownerInfo.address;
                document.getElementById('owner-siret').value = ownerInfo.siret;
            }
            
            const savedItems = localStorage.getItem('invoiceLastItems');
            if (savedItems) {
                invoiceItems = JSON.parse(savedItems);
                renderItemsListMobile();
            }
        }
        
        // Ajouter un article à la facture
        function addInvoiceItem() {
            const description = document.getElementById('item-description').value;
            const quantity = parseInt(document.getElementById('item-quantity').value);
            const price = parseFloat(document.getElementById('item-price').value);
            const tax = parseInt(document.getElementById('item-tax').value);
            
            if (!description || quantity <= 0 || price < 0) {
                showInvoiceStatus('Veuillez remplir correctement tous les champs de l\'article', 'error');
                return;
            }
            
            const item = {
                id: Date.now(),
                description,
                quantity,
                price,
                tax
            };
            
            invoiceItems.push(item);
            renderItemsListMobile();
            updateInvoicePreview();
            
            document.getElementById('item-description').value = '';
            document.getElementById('item-quantity').value = 1;
            document.getElementById('item-price').value = 5000;
            document.getElementById('item-tax').value = 10;
        }
        
        // Afficher la liste des articles (version mobile)
        function renderItemsListMobile() {
            const itemsList = document.getElementById('items-list-mobile');
            itemsList.innerHTML = '';
            
            if (invoiceItems.length === 0) {
                itemsList.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px; color: #999; background: #f9f9f9; border-radius: 12px; border: 2px dashed #ddd;">
                        <i class="fas fa-box-open" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p style="font-size: 16px; font-weight: 500;">Aucun article ajouté</p>
                        <p style="font-size: 14px; margin-top: 5px;">Ajoutez votre premier article ci-dessus</p>
                    </div>
                `;
                return;
            }
            
            invoiceItems.forEach(item => {
                const totalHT = item.quantity * item.price;
                const totalTTC = totalHT + (totalHT * (item.tax / 100));
                
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-card-header">
                        <div class="item-card-title">${item.description}</div>
                        <div class="item-card-actions">
                            <button onclick="removeItem(${item.id})" style="background: #ef4444; color: white; padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="item-card-details">
                        <div class="item-card-detail">
                            <span class="item-card-label">Quantité</span>
                            <span>${item.quantity}</span>
                        </div>
                        <div class="item-card-detail">
                            <span class="item-card-label">Prix unitaire</span>
                            <span>${formatFCFA(item.price)}</span>
                        </div>
                        <div class="item-card-detail">
                            <span class="item-card-label">TVA</span>
                            <span>${item.tax}%</span>
                        </div>
                        <div class="item-card-detail">
                            <span class="item-card-label">Total TTC</span>
                            <span style="font-weight: 600; color: #006400;">${formatFCFA(totalTTC)}</span>
                        </div>
                    </div>
                `;
                itemsList.appendChild(card);
            });
        }
        
        // Supprimer un article
        function removeItem(id) {
            invoiceItems = invoiceItems.filter(item => item.id !== id);
            renderItemsListMobile();
            updateInvoicePreview();
        }
        
        // Générer un aperçu de la facture (version mobile)
        function updateInvoicePreview() {
            const previewEl = document.getElementById('invoice-preview-content');
            
            // Calculer les totaux
            let subtotal = 0;
            let taxAmount = 0;
            let total = 0;
            
            invoiceItems.forEach(item => {
                const itemTotal = item.quantity * item.price;
                subtotal += itemTotal;
                taxAmount += itemTotal * (item.tax / 100);
            });
            
            total = subtotal + taxAmount;
            
            // Convertir le total en lettres
            const totalInWords = numberToFrenchWords(total);
            
            // Obtenir les signatures
            const clientSignatureData = getSignatureDataURL('client');
            const ownerSignatureData = getSignatureDataURL('owner');
            
            // Créer l'aperçu mobile
            previewEl.innerHTML = `
                <div class="invoice-header">
                    <div>
                        <div class="company-logo">
                            <div class="logo-preview">ES</div>
                            <div>
                                <h3 style="font-size: 18px; color: #006400;">${ownerInfo.name}</h3>
                                <p style="font-size: 14px;">${ownerInfo.address || 'Adresse à définir'}</p>
                            </div>
                        </div>
                        <p style="font-size: 14px; margin-top: 5px;">
                            <i class="fas fa-phone"></i> ${ownerInfo.phone}<br>
                            <i class="fas fa-envelope"></i> ${ownerInfo.email}
                        </p>
                    </div>
                </div>
                
                <div class="invoice-details">
                    <div style="flex: 1;">
                        <h4 style="font-size: 16px; margin-bottom: 10px; color: #006400;">Facturé à:</h4>
                        <p style="font-size: 15px; margin-bottom: 5px;"><strong>${document.getElementById('client-name').value || 'Nom du client'}</strong></p>
                        <p style="font-size: 14px;">${document.getElementById('client-phone').value || ''}</p>
                        ${document.getElementById('client-address').value ? `<p style="font-size: 14px;">${document.getElementById('client-address').value}</p>` : ''}
                    </div>
                    
                    <div style="flex: 1;">
                        <h4 style="font-size: 16px; margin-bottom: 10px; color: #006400;">Facture:</h4>
                        <p style="font-size: 14px; margin-bottom: 3px;"><strong>N°:</strong> ${document.getElementById('invoice-number').value || 'FACT-ESODI-XXXX-001'}</p>
                        <p style="font-size: 14px; margin-bottom: 3px;"><strong>Date:</strong> ${document.getElementById('invoice-date').value || new Date().toLocaleDateString('fr-FR')}</p>
                        <p style="font-size: 14px;"><strong>Échéance:</strong> ${document.getElementById('due-date').value || new Date().toLocaleDateString('fr-FR')}</p>
                    </div>
                </div>
                
                <div class="invoice-items-mobile">
                    <h4 style="font-size: 16px; margin-bottom: 15px; color: #006400;">Articles:</h4>
                    ${invoiceItems.length > 0 ? invoiceItems.map(item => {
                        const itemTotal = item.quantity * item.price;
                        const itemTotalTTC = itemTotal + (itemTotal * (item.tax / 100));
                        return `
                            <div class="invoice-item-mobile">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <strong style="font-size: 15px;">${item.description}</strong>
                                    <span style="font-weight: 600; color: #006400;">${formatFCFA(itemTotalTTC)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 13px; color: #666;">
                                    <span>${item.quantity} × ${formatFCFA(item.price)}</span>
                                    <span>TVA: ${item.tax}%</span>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p style="text-align: center; color: #999; padding: 20px;">Aucun article ajouté</p>'}
                </div>
                
                <div class="invoice-totals">
                    <div class="total-row">
                        <span>Sous-total HT:</span>
                        <span>${formatFCFA(subtotal)}</span>
                    </div>
                    <div class="total-row">
                        <span>TVA:</span>
                        <span>${formatFCFA(taxAmount)}</span>
                    </div>
                    <div class="total-row">
                        <span><strong>Total TTC:</strong></span>
                        <span><strong>${formatFCFA(total)}</strong></span>
                    </div>
                </div>
                
                <div class="amount-in-words">
                    <p><strong>Arrêtée à la somme de :</strong><br>${totalInWords}</p>
                </div>
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px dashed #ddd;">
                    <h4 style="font-size: 16px; margin-bottom: 15px; color: #006400;">Signatures:</h4>
                    
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Client:</p>
                            ${clientSignatureData ? 
                                `<img src="${clientSignatureData}" class="signature-preview-img" alt="Signature client">` :
                                '<p style="color: #999; font-size: 13px;">Signature non ajoutée</p>'
                            }
                        </div>
                        
                        <div>
                            <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">ESODI:</p>
                            ${ownerSignatureData ? 
                                `<img src="${ownerSignatureData}" class="signature-preview-img" alt="Signature ESODI">` :
                                '<p style="color: #999; font-size: 13px;">Signature non ajoutée</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            // Mettre à jour également la zone d'impression
            updatePrintArea();
        }
        
        // CORRECTION : Mettre à jour la zone d'impression avec un format spécifique pour l'impression
        function updatePrintArea() {
            const printContent = document.getElementById('print-content');
            
            // Calculer les totaux
            let subtotal = 0;
            let taxAmount = 0;
            let total = 0;
            
            invoiceItems.forEach(item => {
                const itemTotal = item.quantity * item.price;
                subtotal += itemTotal;
                taxAmount += itemTotal * (item.tax / 100);
            });
            
            total = subtotal + taxAmount;
            
            // Convertir le total en lettres
            const totalInWords = numberToFrenchWords(total);
            
            // Obtenir les signatures
            const clientSignatureData = getSignatureDataURL('client');
            const ownerSignatureData = getSignatureDataURL('owner');
            
            // Créer le contenu d'impression avec un format adapté pour l'impression
            printContent.innerHTML = `
                <div class="print-header">
                    <div class="print-logo">ES</div>
                    <h1 style="color: #006400; margin-bottom: 5px;">${ownerInfo.name}</h1>
                    <p style="font-size: 16px;">${ownerInfo.address || 'Adresse à définir'}</p>
                    <p style="font-size: 14px; margin-top: 5px;">
                        <strong>Téléphone:</strong> ${ownerInfo.phone} | 
                        <strong>Email:</strong> ${ownerInfo.email}
                    </p>
                    ${ownerInfo.siret ? `<p style="font-size: 14px;"><strong>RCCM:</strong> ${ownerInfo.siret}</p>` : ''}
                </div>
                
                <div class="print-section">
                    <h2 style="color: #006400; border-bottom: 2px solid #006400; padding-bottom: 10px; margin-bottom: 20px;">
                        FACTURE N°: ${document.getElementById('invoice-number').value || 'FACT-ESODI-XXXX-001'}
                    </h2>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div style="flex: 1;">
                            <h3 style="color: #006400; margin-bottom: 10px;">Facturé à:</h3>
                            <p style="font-size: 16px; margin-bottom: 5px;"><strong>${document.getElementById('client-name').value || 'Nom du client'}</strong></p>
                            <p style="font-size: 14px;">${document.getElementById('client-phone').value || ''}</p>
                            ${document.getElementById('client-email').value ? `<p style="font-size: 14px;">${document.getElementById('client-email').value}</p>` : ''}
                            ${document.getElementById('client-address').value ? `<p style="font-size: 14px;">${document.getElementById('client-address').value}</p>` : ''}
                        </div>
                        
                        <div style="flex: 1; text-align: right;">
                            <h3 style="color: #006400; margin-bottom: 10px;">Détails facture:</h3>
                            <p style="font-size: 14px; margin-bottom: 5px;"><strong>Date facturation:</strong> ${document.getElementById('invoice-date').value || new Date().toLocaleDateString('fr-FR')}</p>
                            <p style="font-size: 14px; margin-bottom: 5px;"><strong>Date échéance:</strong> ${document.getElementById('due-date').value || new Date().toLocaleDateString('fr-FR')}</p>
                            <p style="font-size: 14px;"><strong>Méthode paiement:</strong> ${document.getElementById('payment-method').value || 'Mobile Money'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="print-section">
                    <h3 style="color: #006400; margin-bottom: 15px;">Articles et Services</h3>
                    
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th>TVA</th>
                                <th>Total TTC</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.length > 0 ? invoiceItems.map(item => {
                                const itemTotal = item.quantity * item.price;
                                const itemTotalTTC = itemTotal + (itemTotal * (item.tax / 100));
                                return `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatFCFA(item.price)}</td>
                                        <td>${item.tax}%</td>
                                        <td>${formatFCFA(itemTotalTTC)}</td>
                                    </tr>
                                `;
                            }).join('') : '<tr><td colspan="5" style="text-align: center;">Aucun article</td></tr>'}
                        </tbody>
                    </table>
                </div>
                
                <div class="print-totals">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 16px;">Sous-total HT:</span>
                        <span style="font-size: 16px; font-weight: bold;">${formatFCFA(subtotal)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 16px;">TVA:</span>
                        <span style="font-size: 16px; font-weight: bold;">${formatFCFA(taxAmount)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #006400;">
                        <span style="font-size: 18px; font-weight: bold;">TOTAL TTC:</span>
                        <span style="font-size: 20px; font-weight: bold; color: #006400;">${formatFCFA(total)}</span>
                    </div>
                    
                    <div class="amount-in-words" style="margin-top: 20px; padding: 15px; background: #f0fff0; border-radius: 8px;">
                        <p style="font-size: 16px;"><strong>Arrêtée à la somme de :</strong><br>${totalInWords}</p>
                    </div>
                </div>
                
                ${document.getElementById('invoice-notes').value ? `
                    <div class="print-section">
                        <h3 style="color: #006400; margin-bottom: 10px;">Notes:</h3>
                        <p style="font-size: 14px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                            ${document.getElementById('invoice-notes').value}
                        </p>
                    </div>
                ` : ''}
                
                <div class="print-signatures">
                    <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                        <div style="text-align: center; flex: 1;">
                            <p style="font-size: 16px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #666; padding-bottom: 5px; display: inline-block;">
                                Signature du Client
                            </p>
                            ${clientSignatureData ? 
                                `<img src="${clientSignatureData}" style="max-width: 200px; max-height: 80px; display: block; margin: 10px auto;" alt="Signature client">` :
                                '<div style="height: 80px; border-bottom: 1px solid #666; margin: 10px 0;"></div>'
                            }
                            <p style="margin-top: 10px; font-size: 14px;">${document.getElementById('client-name').value || 'Nom du client'}</p>
                            <p style="font-size: 12px; color: #666;">Date: ${document.getElementById('invoice-date').value || new Date().toLocaleDateString('fr-FR')}</p>
                        </div>
                        
                        <div style="text-align: center; flex: 1;">
                            <p style="font-size: 16px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #666; padding-bottom: 5px; display: inline-block;">
                                Signature ESODI
                            </p>
                            ${ownerSignatureData ? 
                                `<img src="${ownerSignatureData}" style="max-width: 200px; max-height: 80px; display: block; margin: 10px auto;" alt="Signature ESODI">` :
                                '<div style="height: 80px; border-bottom: 1px solid #666; margin: 10px 0;"></div>'
                            }
                            <p style="margin-top: 10px; font-size: 14px;">${ownerInfo.name}</p>
                            <p style="font-size: 12px; color: #666;">Date: ${document.getElementById('invoice-date').value || new Date().toLocaleDateString('fr-FR')}</p>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px; font-size: 12px; color: #666; border-top: 1px solid #ddd; padding-top: 20px;">
                    <p>Merci pour votre confiance !</p>
                    <p>ESODI - WhatsApp: ${ownerInfo.phone} - Email: ${ownerInfo.email}</p>
                    <p>Cette facture a été générée électroniquement et ne nécessite pas de cachet</p>
                </div>
            `;
        }
        
        // CORRECTION : Imprimer la facture
        function printInvoice() {
            if (invoiceItems.length === 0) {
                showInvoiceStatus('Ajoutez des articles avant d\'imprimer', 'error');
                return;
            }
            
            // Mettre à jour la zone d'impression avec les données actuelles
            updatePrintArea();
            
            // Créer une nouvelle fenêtre pour l'impression
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Facture ESODI - ${document.getElementById('invoice-number').value}</title>
                    <style>
                        @media print {
                            body {
                                font-family: Arial, sans-serif;
                                margin: 20px;
                                color: #333;
                            }
                            
                            .print-area {
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 20px;
                                background: white;
                            }
                            
                            .print-header {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 3px solid #006400;
                                padding-bottom: 20px;
                            }
                            
                            .print-logo {
                                font-size: 48px;
                                background: #006400;
                                color: white;
                                width: 80px;
                                height: 80px;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 15px;
                                font-weight: bold;
                            }
                            
                            .print-section {
                                margin-bottom: 25px;
                                page-break-inside: avoid;
                            }
                            
                            .print-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 20px 0;
                            }
                            
                            .print-table th {
                                background-color: #f0f0f0;
                                padding: 12px;
                                text-align: left;
                                border: 1px solid #ddd;
                                font-weight: bold;
                            }
                            
                            .print-table td {
                                padding: 12px;
                                border: 1px solid #ddd;
                            }
                            
                            .print-totals {
                                background-color: #f9f9f9;
                                padding: 20px;
                                border: 2px solid #006400;
                                margin-top: 30px;
                                page-break-inside: avoid;
                            }
                            
                            .print-signatures {
                                margin-top: 50px;
                                padding-top: 30px;
                                border-top: 2px dashed #666;
                                page-break-inside: avoid;
                            }
                            
                            h1, h2, h3 {
                                color: #006400;
                            }
                            
                            .amount-in-words {
                                background-color: #f0fff0;
                                padding: 15px;
                                border-radius: 8px;
                                margin-top: 15px;
                                border-left: 4px solid #006400;
                            }
                            
                            @page {
                                margin: 20mm;
                            }
                        }
                        
                        /* Styles pour l'aperçu à l'écran */
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            color: #333;
                            background: #f5f5f5;
                        }
                        
                        .print-area {
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 30px;
                            background: white;
                            box-shadow: 0 0 20px rgba(0,0,0,0.1);
                            border-radius: 10px;
                        }
                        
                        .print-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #006400;
                            padding-bottom: 20px;
                        }
                        
                        .print-logo {
                            font-size: 48px;
                            background: #006400;
                            color: white;
                            width: 80px;
                            height: 80px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 15px;
                            font-weight: bold;
                        }
                        
                        .print-section {
                            margin-bottom: 25px;
                        }
                        
                        .print-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        
                        .print-table th {
                            background-color: #f0f0f0;
                            padding: 12px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-weight: bold;
                        }
                        
                        .print-table td {
                            padding: 12px;
                            border: 1px solid #ddd;
                        }
                        
                        .print-totals {
                            background-color: #f9f9f9;
                            padding: 20px;
                            border: 2px solid #006400;
                            margin-top: 30px;
                        }
                        
                        .print-signatures {
                            margin-top: 50px;
                            padding-top: 30px;
                            border-top: 2px dashed #666;
                        }
                        
                        h1, h2, h3 {
                            color: #006400;
                        }
                        
                        .amount-in-words {
                            background-color: #f0fff0;
                            padding: 15px;
                            border-radius: 8px;
                            margin-top: 15px;
                            border-left: 4px solid #006400;
                        }
                        
                        .print-actions {
                            text-align: center;
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 1px solid #ddd;
                        }
                        
                        button {
                            background-color: #006400;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 16px;
                            margin: 0 10px;
                        }
                        
                        button:hover {
                            background-color: #228B22;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-area">
                        ${document.getElementById('print-content').innerHTML}
                        
                        <div class="print-actions">
                            <button onclick="window.print()">Imprimer</button>
                            <button onclick="window.close()">Fermer</button>
                        </div>
                    </div>
                    
                    <script>
                        // Redimensionner les images de signature pour l'impression
                        window.onload = function() {
                            const images = document.querySelectorAll('img');
                            images.forEach(img => {
                                img.style.maxWidth = '200px';
                                img.style.maxHeight = '80px';
                                img.style.display = 'block';
                                img.style.margin = '10px auto';
                            });
                        };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Afficher un message de succès
            showInvoiceStatus('Prévisualisation d\'impression ouverte !', 'success');
        }
        
        // Générer la facture complète
        function generateInvoice() {
            const clientName = document.getElementById('client-name').value;
            const clientPhone = document.getElementById('client-phone').value;
            
            if (!clientName || !clientPhone) {
                showInvoiceStatus('Remplissez le nom et téléphone du client', 'error');
                return;
            }
            
            if (invoiceItems.length === 0) {
                showInvoiceStatus('Ajoutez au moins un article', 'error');
                return;
            }
            
            updateInvoicePreview();
            showInvoiceStatus('Aperçu actualisé !', 'success');
        }
        
        // Sauvegarder ET envoyer la facture par WhatsApp
        function saveAndSendInvoice() {
            const clientName = document.getElementById('client-name').value;
            const clientPhone = document.getElementById('client-phone').value;
            
            if (!clientName || !clientPhone) {
                showInvoiceStatus('Nom et téléphone client requis', 'error');
                return;
            }
            
            if (invoiceItems.length === 0) {
                showInvoiceStatus('Ajoutez des articles d\'abord', 'error');
                return;
            }
            
            saveSignature('client');
            saveSignature('owner');
            
            const clientSigData = getSignatureDataURL('client');
            const ownerSigData = getSignatureDataURL('owner');
            
            const invoice = {
                id: Date.now(),
                number: document.getElementById('invoice-number').value,
                date: document.getElementById('invoice-date').value,
                dueDate: document.getElementById('due-date').value,
                client: {
                    name: clientName,
                    phone: clientPhone,
                    email: document.getElementById('client-email').value,
                    address: document.getElementById('client-address').value
                },
                items: [...invoiceItems],
                paymentMethod: document.getElementById('payment-method').value,
                notes: document.getElementById('invoice-notes').value,
                clientSignature: clientSigData,
                ownerSignature: ownerSigData,
                currency: "FCFA",
                createdAt: new Date().toISOString()
            };
            
            // Sauvegarder la facture
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            savedInvoices.push(invoice);
            localStorage.setItem('savedInvoices', JSON.stringify(savedInvoices));
            
            // Sauvegarder les articles pour réutilisation
            localStorage.setItem('invoiceLastItems', JSON.stringify(invoiceItems));
            
            // Envoyer par WhatsApp si activé
            if (autoWhatsAppEnabled) {
                sendWhatsAppMessage(invoice);
                showInvoiceStatus(`Facture sauvegardée et envoyée sur WhatsApp !`, 'success');
            } else {
                showInvoiceStatus('Facture sauvegardée !', 'success');
            }
            
            // Mettre à jour l'analyse
            updateAnalytics();
        }
        
        // Fonction pour envoyer le message WhatsApp
        function sendWhatsAppMessage(invoice) {
            let subtotal = 0;
            let taxAmount = 0;
            invoice.items.forEach(item => {
                const itemTotal = item.quantity * item.price;
                subtotal += itemTotal;
                taxAmount += itemTotal * (item.tax / 100);
            });
            const total = subtotal + taxAmount;
            const totalInWords = numberToFrenchWords(total);
            
            let message = `*📋 FACTURE ESODI - ${invoice.number}*%0A%0A`;
            message += `*Bonjour ${invoice.client.name}*,%0A%0A`;
            message += `Voici votre facture :%0A%0A`;
            
            message += `*DÉTAILS*%0A`;
            message += `N°: ${invoice.number}%0A`;
            message += `Date: ${invoice.date}%0A`;
            message += `Échéance: ${invoice.dueDate}%0A`;
            message += `Paiement: ${invoice.paymentMethod}%0A%0A`;
            
            message += `*ARTICLES*%0A`;
            invoice.items.forEach((item, index) => {
                const itemTotal = item.quantity * item.price;
                const itemTotalTTC = itemTotal + (itemTotal * (item.tax / 100));
                message += `${index + 1}. ${item.description}%0A`;
                message += `   ${item.quantity} × ${formatFCFA(item.price)}%0A`;
                message += `   TVA ${item.tax}% → ${formatFCFA(itemTotalTTC)}%0A%0A`;
            });
            
            message += `*TOTAUX*%0A`;
            message += `Sous-total HT: ${formatFCFA(subtotal)}%0A`;
            message += `TVA: ${formatFCFA(taxAmount)}%0A`;
            message += `*TOTAL TTC: ${formatFCFA(total)}*%0A%0A`;
            
            message += `*MONTANT EN LETTRES*%0A`;
            message += `${totalInWords}%0A%0A`;
            
            if (invoice.notes) {
                message += `*NOTES*%0A`;
                message += `${invoice.notes}%0A%0A`;
            }
            
            message += `*ESODI*%0A`;
            message += `📞 ${ownerInfo.phone}%0A`;
            message += `📧 ${ownerInfo.email}%0A`;
            if (ownerInfo.address) message += `📍 ${ownerInfo.address}%0A%0A`;
            
            message += `*PAIEMENT*%0A`;
            message += `Mobile Money: *${ownerInfo.phone}*%0A%0A`;
            
            message += `Merci pour votre confiance !%0A`;
            message += `*L'équipe ESODI*`;
            
            const formattedPhone = invoice.client.phone.replace(/\s+/g, '').replace('+', '');
            const whatsappURL = `https://wa.me/${formattedPhone}?text=${message}`;
            window.open(whatsappURL, '_blank');
        }
        
        // Effacer le formulaire
        function clearForm() {
            if (confirm('Créer une nouvelle facture ?')) {
                document.getElementById('client-name').value = '';
                document.getElementById('client-phone').value = '';
                document.getElementById('client-email').value = '';
                document.getElementById('client-address').value = '';
                
                const nextInvoiceNumber = parseInt(localStorage.getItem('lastInvoiceNumber') || '0') + 1;
                localStorage.setItem('lastInvoiceNumber', nextInvoiceNumber);
                document.getElementById('invoice-number').value = `FACT-ESODI-${new Date().getFullYear()}-${nextInvoiceNumber.toString().padStart(3, '0')}`;
                
                const today = new Date().toISOString().split('T')[0];
                const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                document.getElementById('invoice-date').value = today;
                document.getElementById('due-date').value = nextWeek;
                
                document.getElementById('invoice-notes').value = '';
                
                invoiceItems = [];
                renderItemsListMobile();
                
                updateInvoicePreview();
                
                showInvoiceStatus('Nouvelle facture prête !', 'success');
            }
        }
        
        // Charger l'historique des factures
        function loadInvoiceHistory(filteredInvoices = null) {
            const invoiceList = document.getElementById('invoice-history-list');
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            const invoices = filteredInvoices || savedInvoices;
            
            if (invoices.length === 0) {
                invoiceList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999; background: #f9f9f9; border-radius: 12px; border: 2px dashed #ddd;">
                        <i class="fas fa-file-invoice" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 18px; font-weight: 500;">Aucune facture enregistrée</p>
                        <p style="font-size: 14px; margin-top: 10px; max-width: 400px; margin-left: auto; margin-right: auto;">
                            Créez votre première facture dans l'onglet "Facture"
                        </p>
                    </div>
                `;
                return;
            }
            
            invoiceList.innerHTML = '';
            
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(invoice => {
                // Calculer le total de la facture
                let total = 0;
                invoice.items.forEach(item => {
                    const itemTotal = item.quantity * item.price;
                    total += itemTotal + (itemTotal * (item.tax / 100));
                });
                
                const card = document.createElement('div');
                card.className = 'invoice-card';
                card.innerHTML = `
                    <div class="invoice-card-header">
                        <div>
                            <div class="invoice-card-title">${invoice.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                Client: ${invoice.client.name}
                            </div>
                        </div>
                        <div class="invoice-card-actions">
                            <div class="action-buttons-row">
                                <button class="action-button-small btn-info" onclick="viewInvoice(${invoice.id})" style="background-color: #3b82f6;">
                                    <i class="fas fa-eye"></i> Voir
                                </button>
                                <button class="action-button-small btn-whatsapp" onclick="resendInvoice(${invoice.id})" style="background-color: #25D366;">
                                    <i class="fab fa-whatsapp"></i> Renvoyer
                                </button>
                                <button class="action-button-small btn-warning" onclick="printSavedInvoice(${invoice.id})" style="background-color: #f59e0b;">
                                    <i class="fas fa-print"></i> Imprimer
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="invoice-card-details">
                        <div class="invoice-card-detail">
                            <span class="invoice-card-label">Date facturation</span>
                            <span>${invoice.date}</span>
                        </div>
                        <div class="invoice-card-detail">
                            <span class="invoice-card-label">Date échéance</span>
                            <span>${invoice.dueDate}</span>
                        </div>
                        <div class="invoice-card-detail">
                            <span class="invoice-card-label">Téléphone</span>
                            <span>${invoice.client.phone}</span>
                        </div>
                        <div class="invoice-card-detail">
                            <span class="invoice-card-label">Méthode paiement</span>
                            <span>${invoice.paymentMethod}</span>
                        </div>
                    </div>
                    
                    <div class="invoice-card-total">
                        Total: ${formatFCFA(total)}
                    </div>
                `;
                invoiceList.appendChild(card);
            });
        }
        
        // Appliquer le filtre
        function applyFilter() {
            const clientFilter = document.getElementById('filter-client').value.toLowerCase();
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            
            let filteredInvoices = savedInvoices;
            
            // Filtrer par nom de client
            if (clientFilter) {
                filteredInvoices = filteredInvoices.filter(invoice => 
                    invoice.client.name.toLowerCase().includes(clientFilter)
                );
            }
            
            // Filtrer par date
            if (dateFrom) {
                filteredInvoices = filteredInvoices.filter(invoice => 
                    invoice.date >= dateFrom
                );
            }
            
            if (dateTo) {
                filteredInvoices = filteredInvoices.filter(invoice => 
                    invoice.date <= dateTo
                );
            }
            
            loadInvoiceHistory(filteredInvoices);
            
            // Afficher le nombre de résultats
            const invoiceList = document.getElementById('invoice-history-list');
            const resultsCount = document.createElement('div');
            resultsCount.style.cssText = 'text-align: center; padding: 10px; color: #666; font-size: 14px;';
            resultsCount.innerHTML = `${filteredInvoices.length} facture(s) trouvée(s)`;
            invoiceList.insertBefore(resultsCount, invoiceList.firstChild);
        }
        
        // Effacer le filtre
        function clearFilter() {
            document.getElementById('filter-client').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            loadInvoiceHistory();
        }
        
        // Voir une facture
        function viewInvoice(invoiceId) {
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            const invoice = savedInvoices.find(inv => inv.id === invoiceId);
            
            if (invoice) {
                // Pré-remplir le formulaire avec les données de la facture
                document.getElementById('client-name').value = invoice.client.name;
                document.getElementById('client-phone').value = invoice.client.phone;
                document.getElementById('client-email').value = invoice.client.email || '';
                document.getElementById('client-address').value = invoice.client.address || '';
                
                document.getElementById('invoice-number').value = invoice.number;
                document.getElementById('invoice-date').value = invoice.date;
                document.getElementById('due-date').value = invoice.dueDate;
                document.getElementById('payment-method').value = invoice.paymentMethod;
                document.getElementById('invoice-notes').value = invoice.notes || '';
                
                // Charger les articles
                invoiceItems = invoice.items;
                renderItemsListMobile();
                
                // Charger les signatures si disponibles
                if (invoice.clientSignature) {
                    localStorage.setItem('clientSignature', invoice.clientSignature);
                }
                if (invoice.ownerSignature) {
                    localStorage.setItem('ownerSignature', invoice.ownerSignature);
                }
                loadSavedSignatures();
                
                // Mettre à jour l'aperçu
                updateInvoicePreview();
                
                // Basculer vers l'onglet facture
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                document.querySelector('[data-tab="client"]').classList.add('active');
                document.getElementById('client-tab').classList.add('active');
                
                showInvoiceStatus('Facture chargée avec succès !', 'success');
            }
        }
        
        // Renvoyer une facture
        function resendInvoice(invoiceId) {
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            const invoice = savedInvoices.find(inv => inv.id === invoiceId);
            
            if (invoice) {
                sendWhatsAppMessage(invoice);
                showInvoiceStatus('Facture renvoyée sur WhatsApp !', 'success');
            }
        }
        
        // Imprimer une facture sauvegardée
        function printSavedInvoice(invoiceId) {
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            const invoice = savedInvoices.find(inv => inv.id === invoiceId);
            
            if (invoice) {
                // Créer une nouvelle fenêtre pour l'impression
                const printWindow = window.open('', '_blank');
                
                // Calculer les totaux
                let subtotal = 0;
                let taxAmount = 0;
                let total = 0;
                
                invoice.items.forEach(item => {
                    const itemTotal = item.quantity * item.price;
                    subtotal += itemTotal;
                    taxAmount += itemTotal * (item.tax / 100);
                });
                
                total = subtotal + taxAmount;
                const totalInWords = numberToFrenchWords(total);
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="fr">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Facture ESODI - ${invoice.number}</title>
                        <style>
                            @media print {
                                body {
                                    font-family: Arial, sans-serif;
                                    margin: 20px;
                                    color: #333;
                                }
                                
                                .print-area {
                                    max-width: 800px;
                                    margin: 0 auto;
                                    padding: 20px;
                                    background: white;
                                }
                                
                                .print-header {
                                    text-align: center;
                                    margin-bottom: 30px;
                                    border-bottom: 3px solid #006400;
                                    padding-bottom: 20px;
                                }
                                
                                .print-logo {
                                    font-size: 48px;
                                    background: #006400;
                                    color: white;
                                    width: 80px;
                                    height: 80px;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin: 0 auto 15px;
                                    font-weight: bold;
                                }
                                
                                .print-section {
                                    margin-bottom: 25px;
                                    page-break-inside: avoid;
                                }
                                
                                .print-table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin: 20px 0;
                                }
                                
                                .print-table th {
                                    background-color: #f0f0f0;
                                    padding: 12px;
                                    text-align: left;
                                    border: 1px solid #ddd;
                                    font-weight: bold;
                                }
                                
                                .print-table td {
                                    padding: 12px;
                                    border: 1px solid #ddd;
                                }
                                
                                .print-totals {
                                    background-color: #f9f9f9;
                                    padding: 20px;
                                    border: 2px solid #006400;
                                    margin-top: 30px;
                                    page-break-inside: avoid;
                                }
                                
                                .print-signatures {
                                    margin-top: 50px;
                                    padding-top: 30px;
                                    border-top: 2px dashed #666;
                                    page-break-inside: avoid;
                                }
                                
                                h1, h2, h3 {
                                    color: #006400;
                                }
                                
                                .amount-in-words {
                                    background-color: #f0fff0;
                                    padding: 15px;
                                    border-radius: 8px;
                                    margin-top: 15px;
                                    border-left: 4px solid #006400;
                                }
                                
                                @page {
                                    margin: 20mm;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-area">
                            <div class="print-header">
                                <div class="print-logo">ES</div>
                                <h1 style="color: #006400; margin-bottom: 5px;">${ownerInfo.name}</h1>
                                <p style="font-size: 16px;">${ownerInfo.address || 'Adresse à définir'}</p>
                                <p style="font-size: 14px; margin-top: 5px;">
                                    <strong>Téléphone:</strong> ${ownerInfo.phone} | 
                                    <strong>Email:</strong> ${ownerInfo.email}
                                </p>
                            </div>
                            
                            <div class="print-section">
                                <h2 style="color: #006400; border-bottom: 2px solid #006400; padding-bottom: 10px; margin-bottom: 20px;">
                                    FACTURE N°: ${invoice.number}
                                </h2>
                                
                                <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                                    <div style="flex: 1;">
                                        <h3 style="color: #006400; margin-bottom: 10px;">Facturé à:</h3>
                                        <p style="font-size: 16px; margin-bottom: 5px;"><strong>${invoice.client.name}</strong></p>
                                        <p style="font-size: 14px;">${invoice.client.phone}</p>
                                        ${invoice.client.email ? `<p style="font-size: 14px;">${invoice.client.email}</p>` : ''}
                                        ${invoice.client.address ? `<p style="font-size: 14px;">${invoice.client.address}</p>` : ''}
                                    </div>
                                    
                                    <div style="flex: 1; text-align: right;">
                                        <h3 style="color: #006400; margin-bottom: 10px;">Détails facture:</h3>
                                        <p style="font-size: 14px; margin-bottom: 5px;"><strong>Date facturation:</strong> ${invoice.date}</p>
                                        <p style="font-size: 14px; margin-bottom: 5px;"><strong>Date échéance:</strong> ${invoice.dueDate}</p>
                                        <p style="font-size: 14px;"><strong>Méthode paiement:</strong> ${invoice.paymentMethod}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="print-section">
                                <h3 style="color: #006400; margin-bottom: 15px;">Articles et Services</h3>
                                
                                <table class="print-table">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Quantité</th>
                                            <th>Prix unitaire</th>
                                            <th>TVA</th>
                                            <th>Total TTC</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${invoice.items.map(item => {
                                            const itemTotal = item.quantity * item.price;
                                            const itemTotalTTC = itemTotal + (itemTotal * (item.tax / 100));
                                            return `
                                                <tr>
                                                    <td>${item.description}</td>
                                                    <td>${item.quantity}</td>
                                                    <td>${formatFCFA(item.price)}</td>
                                                    <td>${item.tax}%</td>
                                                    <td>${formatFCFA(itemTotalTTC)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="print-totals">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-size: 16px;">Sous-total HT:</span>
                                    <span style="font-size: 16px; font-weight: bold;">${formatFCFA(subtotal)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-size: 16px;">TVA:</span>
                                    <span style="font-size: 16px; font-weight: bold;">${formatFCFA(taxAmount)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #006400;">
                                    <span style="font-size: 18px; font-weight: bold;">TOTAL TTC:</span>
                                    <span style="font-size: 20px; font-weight: bold; color: #006400;">${formatFCFA(total)}</span>
                                </div>
                                
                                <div class="amount-in-words" style="margin-top: 20px; padding: 15px; background: #f0fff0; border-radius: 8px;">
                                    <p style="font-size: 16px;"><strong>Arrêtée à la somme de :</strong><br>${totalInWords}</p>
                                </div>
                            </div>
                            
                            ${invoice.notes ? `
                                <div class="print-section">
                                    <h3 style="color: #006400; margin-bottom: 10px;">Notes:</h3>
                                    <p style="font-size: 14px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                                        ${invoice.notes}
                                    </p>
                                </div>
                            ` : ''}
                            
                            <div class="print-signatures">
                                <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                                    <div style="text-align: center; flex: 1;">
                                        <p style="font-size: 16px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #666; padding-bottom: 5px; display: inline-block;">
                                            Signature du Client
                                        </p>
                                        ${invoice.clientSignature ? 
                                            `<img src="${invoice.clientSignature}" style="max-width: 200px; max-height: 80px; display: block; margin: 10px auto;" alt="Signature client">` :
                                            '<div style="height: 80px; border-bottom: 1px solid #666; margin: 10px 0;"></div>'
                                        }
                                        <p style="margin-top: 10px; font-size: 14px;">${invoice.client.name}</p>
                                        <p style="font-size: 12px; color: #666;">Date: ${invoice.date}</p>
                                    </div>
                                    
                                    <div style="text-align: center; flex: 1;">
                                        <p style="font-size: 16px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #666; padding-bottom: 5px; display: inline-block;">
                                            Signature ESODI
                                        </p>
                                        ${invoice.ownerSignature ? 
                                            `<img src="${invoice.ownerSignature}" style="max-width: 200px; max-height: 80px; display: block; margin: 10px auto;" alt="Signature ESODI">` :
                                            '<div style="height: 80px; border-bottom: 1px solid #666; margin: 10px 0;"></div>'
                                        }
                                        <p style="margin-top: 10px; font-size: 14px;">${ownerInfo.name}</p>
                                        <p style="font-size: 12px; color: #666;">Date: ${invoice.date}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 40px; font-size: 12px; color: #666; border-top: 1px solid #ddd; padding-top: 20px;">
                                <p>Merci pour votre confiance !</p>
                                <p>ESODI - WhatsApp: ${ownerInfo.phone} - Email: ${ownerInfo.email}</p>
                                <p>Cette facture a été générée électroniquement et ne nécessite pas de cachet</p>
                            </div>
                        </div>
                        
                        <script>
                            window.onload = function() {
                                window.print();
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
            }
        }
        
        // Initialiser les graphiques
        function initCharts() {
            const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
            const paymentCtx = document.getElementById('payment-chart').getContext('2d');
            const clientsCtx = document.getElementById('clients-chart').getContext('2d');
            
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Chiffre d\'affaires (FCFA)',
                        data: [],
                        borderColor: '#006400',
                        backgroundColor: 'rgba(0, 100, 0, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatFCFA(value);
                                }
                            }
                        }
                    }
                }
            });
            
            paymentChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#25D366',
                            '#3b82f6',
                            '#f59e0b',
                            '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            clientsChart = new Chart(clientsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Chiffre d\'affaires (FCFA)',
                        data: [],
                        backgroundColor: '#006400'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatFCFA(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Mettre à jour les analyses
        function updateAnalytics() {
            const savedInvoices = JSON.parse(localStorage.getItem('savedInvoices') || '[]');
            
            if (savedInvoices.length === 0) {
                resetAnalytics();
                return;
            }
            
            // Calculer les statistiques
            let totalRevenue = 0;
            let currentMonthRevenue = 0;
            let lastMonthRevenue = 0;
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            // Groupement par mois pour le graphique
            const monthlyData = {};
            const paymentMethods = {};
            const clientRevenues = {};
            
            savedInvoices.forEach(invoice => {
                // Calculer le total de la facture
                let invoiceTotal = 0;
                invoice.items.forEach(item => {
                    const itemTotal = item.quantity * item.price;
                    invoiceTotal += itemTotal + (itemTotal * (item.tax / 100));
                });
                
                totalRevenue += invoiceTotal;
                
                // Groupement par mois
                const invoiceDate = new Date(invoice.date);
                const monthYear = `${invoiceDate.getMonth() + 1}/${invoiceDate.getFullYear()}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = 0;
                }
                monthlyData[monthYear] += invoiceTotal;
                
                // Groupement par méthode de paiement
                const paymentMethod = invoice.paymentMethod;
                if (!paymentMethods[paymentMethod]) {
                    paymentMethods[paymentMethod] = 0;
                }
                paymentMethods[paymentMethod] += invoiceTotal;
                
                // Groupement par client
                const clientName = invoice.client.name;
                if (!clientRevenues[clientName]) {
                    clientRevenues[clientName] = 0;
                }
                clientRevenues[clientName] += invoiceTotal;
                
                // Revenus du mois en cours
                if (invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear) {
                    currentMonthRevenue += invoiceTotal;
                }
                
                // Revenus du mois dernier
                if (invoiceDate.getMonth() === lastMonth && invoiceDate.getFullYear() === lastMonthYear) {
                    lastMonthRevenue += invoiceTotal;
                }
            });
            
            // Mettre à jour les cartes de statistiques
            document.getElementById('total-revenue').textContent = formatFCFA(totalRevenue);
            document.getElementById('total-invoices').textContent = savedInvoices.length;
            document.getElementById('average-invoice').textContent = formatFCFA(totalRevenue / savedInvoices.length);
            
            // Compter les clients uniques
            const uniqueClients = new Set(savedInvoices.map(inv => inv.client.name));
            document.getElementById('active-clients').textContent = uniqueClients.size;
            
            // Calculer les pourcentages de changement
            const revenueChange = lastMonthRevenue > 0 ? 
                ((currentMonthRevenue - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1) : 0;
            const revenueChangeEl = document.getElementById('revenue-change');
            revenueChangeEl.textContent = revenueChange >= 0 ? 
                `+${revenueChange}% vs mois dernier` : 
                `${revenueChange}% vs mois dernier`;
            revenueChangeEl.className = revenueChange >= 0 ? 'stat-change' : 'stat-change negative';
            
            // Mettre à jour le graphique de revenus
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [aMonth, aYear] = a.split('/').map(Number);
                const [bMonth, bYear] = b.split('/').map(Number);
                return aYear - bYear || aMonth - bMonth;
            });
            
            revenueChart.data.labels = sortedMonths;
            revenueChart.data.datasets[0].data = sortedMonths.map(month => monthlyData[month]);
            revenueChart.update();
            
            // Mettre à jour le graphique des méthodes de paiement
            paymentChart.data.labels = Object.keys(paymentMethods);
            paymentChart.data.datasets[0].data = Object.values(paymentMethods);
            paymentChart.update();
            
            // Mettre à jour le graphique des clients (top 5)
            const sortedClients = Object.entries(clientRevenues)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            clientsChart.data.labels = sortedClients.map(client => client[0]);
            clientsChart.data.datasets[0].data = sortedClients.map(client => client[1]);
            clientsChart.update();
        }
        
        // Réinitialiser les analyses
        function resetAnalytics() {
            document.getElementById('total-revenue').textContent = '0 FCFA';
            document.getElementById('total-invoices').textContent = '0';
            document.getElementById('average-invoice').textContent = '0 FCFA';
            document.getElementById('active-clients').textContent = '0';
            document.getElementById('revenue-change').textContent = '+0% vs mois dernier';
            
            // Réinitialiser les graphiques
            revenueChart.data.labels = [];
            revenueChart.data.datasets[0].data = [];
            revenueChart.update();
            
            paymentChart.data.labels = [];
            paymentChart.data.datasets[0].data = [];
            paymentChart.update();
            
            clientsChart.data.labels = [];
            clientsChart.data.datasets[0].data = [];
            clientsChart.update();
        }
        
        // Afficher un message de statut
        function showInvoiceStatus(message, type) {
            const statusEl = document.getElementById('invoice-status');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 4000);
        }
    </script>
</body>
</html>
